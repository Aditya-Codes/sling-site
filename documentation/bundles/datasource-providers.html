<!DOCTYPE html><html lang="en">
    <head>
<meta charset="utf-8"/>
        <title>Apache Sling on JBake</title>
        <link rel="stylesheet" href="/ng/res/css/site.css"/>
        <link rel="icon" href="/ng/res/favicon.ico"/>
        <div class="title">
            <div class="logo">
                <a href="http://sling.apache.org">
                    <img border="0" alt="Apache Sling" src="/ng/res/logos/sling.svg"/>
                </a>
            </div><div class="header">
                <a href="http://www.apache.org">
                    <img border="0" alt="Apache" src="/ng/res/logos/apache.png"/>
                </a>
            </div>
        </div>        
    </head><body>
<div class="menu">
            <strong><a href="/ng/documentation.html">Documentation</a></strong><br/><a href="/ng/documentation/getting-started.html">Getting Started</a><br/><a href="/ng/documentation/the-sling-engine.html">The Sling Engine</a><br/><a href="/ng/documentation/development.html">Development</a><br/><a href="/ng/documentation/bundles.html">Bundles</a><br/><a href="/ng/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a><br/><a href="/ng/documentation/configuration.html">Configuration</a><p></p><a href="http://s.apache.org/sling.wiki">Wiki</a><br/><a href="http://s.apache.org/sling.faq">FAQ</a><br/><p></p><strong>API Docs</strong><br/><a href="/ng/apidocs/sling9/index.html">Sling 9</a><br/><a href="/ng/apidocs/sling8/index.html">Sling 8</a><br/><a href="/ng/apidocs/sling7/index.html">Sling 7</a><br/><a href="/ng/apidocs/sling6/index.html">Sling 6</a><br/><a href="/ng/apidocs/sling5/index.html">Sling 5</a><br/><a href="/ng/javadoc-io.html">Archive at javadoc.io</a><br/><p></p><strong>Project info</strong><br/><a href="/ng/downloads.cgi">Downloads</a><br/><a href="http://www.apache.org/licenses/">License</a><br/><a href="/ng/contributing.html">Contributing</a><br/><a href="/ng/news.html">News</a><br/><a href="/ng/links.html">Links</a><br/><a href="/ng/project-information.html">Project Information</a><br/><a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a><br/><a href="http://ci.apache.org/builders/sling-trunk">Build Server</a><br/><a href="/ng/project-information/security.html">Security</a><br/><p></p><strong>Source</strong><br/><a href="http://svn.apache.org/viewvc/sling/trunk">Subversion</a><br/><a href="git://git.apache.org/sling.git">Git</a><br/><a href="https://github.com/apache/sling">Github Mirror</a><br/><p></p><strong>Sponsorship</strong><br/><a href="http://www.apache.org/foundation/thanks.html">Thanks</a><br/><a href="http://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a><br/><a href="https://donate.apache.org/">Donate!</a><br/><a href="http://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a><br/><p></p><strong><a href="/ng/sitemap.html">Site Map</a></strong>
        </div>        <div class="main">
<div class="row"><div class="small-12 columns"><section class="wrap"><header><h1>DataSource Provider</h1></header><p>DataSource provider bundle supports creation of <code>DataSource</code> instance and registering them with the OSGi service registry. Application using the DataSource just obtains it from OSGi while an administrator can configure the DataSource via Felix WebConsole configuration UI.</p>
<p>[TOC]</p>
<h2>Pooled Connection DataSource Provider</h2>
<p>This bundle enables creating and configuring JDBC DataSource in OSGi environment based on OSGi configuration. It uses <a href="http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html">Tomcat JDBC Pool</a> as the JDBC Connection Pool provider.</p>
<ol>
  <li>Supports configuring the DataSource based on OSGi config with rich metatype</li>
  <li>Supports deploying of JDBC Driver as independent bundles and not as fragment</li>
  <li>Exposes the DataSource stats as JMX MBean</li>
  <li>Supports updating of DataSource connection pool properties at runtime without restart</li>
</ol>
<h3>Driver Loading</h3>
<p>Loading of JDBC driver is tricky on OSGi env. Mostly one has to attach the Driver bundle as a fragment bundle to the code which creates the JDBC Connection.</p>
<p>With JDBC 4 onwards the Driver class can be loaded via Java SE Service Provider mechanism (SPM) JDBC 4.0 drivers must include the file META-INF/services/java.sql.Driver. This file contains the name of the JDBC driver's implementation of java.sql.Driver. For example, to load the JDBC driver to connect to a Apache Derby database, the META-INF/services/java.sql.Driver file would contain the following entry:</p>
<pre><code>org.apache.derby.jdbc.EmbeddedDriver
</code></pre>
<p>Sling DataSource Provider bundles maintains a <code>DriverRegistry</code> which contains mapping of Driver bundle to Driver class supported by it. With this feature there is no need to wrap the Driver bundle as fragment to DataSource provider bundle</p>
<h3>Configuration</h3>
<ol>
  <li>Install the current bundle</li>
  <li>Install the JDBC Driver bundle</li>
  <li>Configure the DataSource from OSGi config for PID <code>org.apache.sling.datasource.DataSourceFactory</code></li>
</ol>
<p>If Felix WebConsole is used then you can configure it via Configuration UI at http://localhost:8080/system/console/configMgr/org.apache.sling.datasource.DataSourceFactory</p>
<p><img src="/documentation/development/sling-datasource-config.png" alt="Web Console Config" /></p>
<p>Using the config ui above one can directly configure most of the properties as explained in <a href="http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html">Tomcat Docs</a></p>
<h3>Convert Driver jars to Bundle</h3>
<p>Most of the JDBC driver jars have the required OSGi headers and can be directly deployed to OSGi container as bundles. However some of the drivers e.g. Postgres are not having such headers and hence need to be converted to OSGi bundles. For them we can use the <a href="http://bnd.bndtools.org/chapters/390-wrapping.html">Bnd Wrap</a> command.</p>
<p>For example to convert the Postgres driver jar follow the steps below</p>
<pre><code>$ wget https://github.com/bndtools/bnd/releases/download/2.3.0.REL/biz.aQute.bnd-2.3.0.jar -O bnd.jar
$ wget http://jdbc.postgresql.org/download/postgresql-9.3-1101.jdbc41.jar
$ cat &gt; bnd.bnd &lt;&lt;EOT
Bundle-Version: 9.3.1101
Bundle-SymbolicName: org.postgresql
Export-Package: org.postgresql
Include-Resource: @postgresql-9.3-1101.jdbc41.jar
EOT
$ java -jar bnd.jar bnd.bnd
</code></pre>
<p>In the steps above we</p>
<ol>
  <li>Download the bnd jar and postgres driver jar</li>
  <li>Create a bnd file with required instructions.</li>
  <li>Execute the bnd command</li>
  <li>Resulting bundle is present in <code>org.postgresql-9.3.1101.jar</code></li>
</ol>
<h2>JNDI DataSource</h2>
<p>While running in Application Server the DataSource instance might be managed by app server and registered with JNDI. To enable lookup of DataSource instance from JNDI you can configure <code>JNDIDataSourceFactory</code></p>
<ol>
  <li>Configure the DataSource from OSGi config for PID <code>org.apache.sling.datasource.JNDIDataSourceFactory</code></li>
  <li>Provide the JNDI name to lookup from and other details</li>
</ol>
<p>If Felix WebConsole is used then you can configure it via Configuration UI at http://localhost:8080/system/console/configMgr/org.apache.sling.datasource.JNDIDataSourceFactory</p>
<p>Once configured <code>JNDIDataSourceFactory</code> would lookup the DataSource instance and register it with OSGi ServiceRegistry</p>
<h2>Usage</h2>
<p>Once the required configuration is done the <code>DataSource</code> would be registered as part of the OSGi Service Registry The service is registered with service property <code>datasource.name</code> whose value is the name of datasource provided in OSGi config.</p>
<p>Following snippet demonstrates accessing the DataSource named <code>foo</code> via DS annotation</p>
<pre><code>::java
import javax.sql.DataSource;
import org.apache.felix.scr.annotations.Reference;

public class DSExample {

    @Reference(target = &quot;(&amp;(objectclass=javax.sql.DataSource)(datasource.name=foo))&quot;)
    private DataSource dataSource;
}
</code></pre>
<h2>Installation</h2>
<p>Download the bundle from <a href="http://sling.apache.org/downloads.cgi">here</a> or use following Maven dependency</p>
<pre><code>::xml
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.sling&lt;/groupId&gt;
    &lt;artifactId&gt;org.apache.sling.datasource&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre></section></div></div>            
<div class="footer">
                <div class="timestamp">
                    TODO display revision number here
                </div><div class="trademarkFooter">
                    Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
                </div>
            </div>            
            
        </div>
    </body>
</html>
