<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling :: OSGi Mocks</title>
        <link rel="icon" href="/ng/res/favicon.ico"/>
        <link rel="stylesheet" href="/ng/res/css/site.css"/>
        
    </head>    <body>
<div class="title">
            <div class="logo">
                <a href="http://sling.apache.org">
                    <img border="0" alt="Apache Sling" src="/ng/res/logos/sling.svg"/>
                </a>
            </div><div class="header">
                <a href="http://www.apache.org">
                    <img border="0" alt="Apache" src="/ng/res/logos/apache.png"/>
                </a>
            </div>
        </div><h1 class="draft">DRAFT 2017 WEBSITE - SLING-6955</h1><div class="menu">
            <p>
                <strong><a href="/ng/documentation.html">Documentation</a></strong><br/>
                <a href="/ng/documentation/getting-started.html">Getting Started</a><br/>
                <a href="/ng/documentation/the-sling-engine.html">The Sling Engine</a><br/>
                <a href="/ng/documentation/development.html">Development</a><br/>
                <a href="/ng/documentation/bundles.html">Bundles</a><br/>
                <a href="/ng/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a><br/>
                <a href="/ng/documentation/configuration.html">Configuration</a>
            </p><p>
                <a href="http://s.apache.org/sling.wiki">Wiki</a><br/>
                <a href="http://s.apache.org/sling.faq">FAQ</a><br/>
                
            </p><p>
                <strong>API Docs</strong><br/>
                <a href="/ng/apidocs/sling9/index.html">Sling 9</a><br/>
                <a href="/ng/apidocs/sling8/index.html">Sling 8</a><br/>
                <a href="/ng/apidocs/sling7/index.html">Sling 7</a><br/>
                <a href="/ng/apidocs/sling6/index.html">Sling 6</a><br/>
                <a href="/ng/apidocs/sling5/index.html">Sling 5</a><br/>
                <a href="/ng/javadoc-io.html">Archive at javadoc.io</a><br/>
                
            </p><p>
                <strong>Project info</strong><br/>
                <a href="/ng/downloads.cgi">Downloads</a><br/>
                <a href="http://www.apache.org/licenses/">License</a><br/>
                <a href="/ng/contributing.html">Contributing</a><br/>
                <a href="/ng/news.html">News</a><br/>
                <a href="/ng/links.html">Links</a><br/>
                <a href="/ng/project-information.html">Project Information</a><br/>
                <a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a><br/>
                <a href="/ng/project-information/security.html">Security</a><br/>
                
            </p><p>
                <strong>Source</strong><br/>
                <a href="http://svn.apache.org/viewvc/sling/trunk">Subversion</a><br/>
                <a href="git://git.apache.org/sling.git">Git</a><br/>
                <a href="https://github.com/apache/sling">Github Mirror</a><br/>
                
            </p><p>
                <strong>Sponsorship</strong><br/>
                <a href="http://www.apache.org/foundation/thanks.html">Thanks</a><br/>
                <a href="http://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a><br/>
                <a href="https://donate.apache.org/">Donate!</a><br/>
                <a href="http://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a><br/>
                
            </p><p>
                <strong><a href="/ng/sitemap.html">Site Map</a></strong>
            </p>
        </div>        <div class="main">
<div class="breadcrumbs"><a href="/ng/">Home</a>&nbsp;&raquo;&nbsp;<a href="/ng/documentation.html">Documentation</a>&nbsp;&raquo;&nbsp;<a href="/ng/documentation/development.html">Development</a>&nbsp;&raquo;&nbsp;</div>            <h1>
                OSGi Mocks
            </h1><div class="row"><div class="small-12 columns"><section class="wrap"><p>Mock implementation of selected OSGi APIs for easier testing.</p>
<p><!-- TODO reactivate TOC once JBake moves to flexmark-java -->
</p>
<h2>Maven Dependency</h2>
<pre><code>#!xml
&lt;dependency&gt;
  &lt;groupId&gt;org.apache.sling&lt;/groupId&gt;
  &lt;artifactId&gt;org.apache.sling.testing.osgi-mock&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>See latest version on the <a href="/downloads.cgi">downloads page</a>.</p>
<p>There are two major version ranges available:</p>
<ul>
  <li>osgi-mock 1.x: compatible with OSGi R4 and above</li>
  <li>osgi-mock 2.x: compatible with OSGi R6 and above</li>
</ul>
<h2>Implemented mock features</h2>
<p>The mock implementation supports:</p>
<ul>
  <li>Instantiating OSGi <code>Bundle</code>, <code>BundleContext</code> and <code>ComponentContext</code> objects and navigate between them.</li>
  <li>Register OSGi SCR services and get references to service instances</li>
  <li>Supports reading OSGi SCR metadata from <code>/OSGI-INF/&lt;pid&gt;.xml</code> and from <code>/OSGI-INF/serviceComponents.xml</code></li>
  <li>Apply service properties/component configuration provided in unit test and from SCR metadata</li>
  <li>Inject SCR dependencies - static and dynamic</li>
  <li>Call lifecycle methods for activating, deactivating or modifying SCR components</li>
  <li>Service and bundle listener implementation</li>
  <li>Mock implementation of <code>LogService</code> which logs to SLF4J in JUnit context</li>
  <li>Mock implementation of <code>EventAdmin</code> which supports <code>EventHandler</code> services</li>
  <li>Mock implementation of <code>ConfigAdmin</code></li>
  <li>Context Plugins</li>
</ul>
<p>Since osgi-mock 2.0.0:</p>
<ul>
  <li>Support OSGi R6 and Declarative Services 1.3: Field-based reference bindings and component property types</li>
</ul>
<h2>Usage</h2>
<h3>OSGi Context JUnit Rule</h3>
<p>The OSGi mock context can be injected into a JUnit test using a custom JUnit rule named <code>OsgiContext</code>. This rules takes care of all initialization and cleanup tasks required to make sure all unit tests can run independently (and in parallel, if required).</p>
<p>Example:</p>
<pre><code>#!java
public class ExampleTest {

  @Rule
  public final OsgiContext context = new OsgiContext();

  @Test
  public void testSomething() {

    // register and activate service with configuration
    MyService service1 = context.registerInjectActivateService(new MyService(),
        &quot;prop1&quot;, &quot;value1&quot;);

    // get service instance
    OtherService service2 = context.getService(OtherService.class);

  }

}
</code></pre>
<p>It is possible to combine such a unit test with a <code>@RunWith</code> annotation e.g. for <a href="http://mockito.github.io/mockito/docs/current/org/mockito/runners/MockitoJUnitRunner.html">Mockito JUnit Runner</a>.</p>
<p>The <code>OsgiContext</code> object provides access to mock implementations of:</p>
<ul>
  <li>OSGi Component Context</li>
  <li>OSGi Bundle Context</li>
</ul>
<p>Additionally it supports:</p>
<ul>
  <li>Registering and activating OSGi services and inject dependencies</li>
</ul>
<h3>Getting OSGi mock objects</h3>
<p>The factory class <code>MockOsgi</code> allows to instantiate the different mock implementations.</p>
<p>Example:</p>
<pre><code>#!java
// get bundle context
BundleContext bundleContext = MockOsgi.newBundleContext();

// get component context with configuration
BundleContext bundleContext = MockOsgi.newComponentContext(properties,
    &quot;prop1&quot;, &quot;value1&quot;);
</code></pre>
<p>It is possible to simulate registering of OSGi services (backed by a simple hash map internally):</p>
<pre><code>#!java
// register service
bundleContext.registerService(MyClass.class, myService, properties);

// get service instance
ServiceReference ref = bundleContext.getServiceReference(MyClass.class.getName());
MyClass service = bundleContext.getService(ref);
</code></pre>
<h3>Activation and Dependency Injection</h3>
<p>It is possible to simulate OSGi service activation, deactivation and dependency injection and the mock implementation tries to to its best to execute all as expected for an OSGi environment.</p>
<p>Example:</p>
<pre><code>#!java
// get bundle context
BundleContext bundleContext = MockOsgi.newBundleContext();

// create service instance manually
MyService service = new MyService();

// inject dependencies
MockOsgi.injectServices(service, bundleContext);

// activate service
MockOsgi.activate(service, props);

// operate with service...

// deactivate service
MockOsgi.deactivate(service);
</code></pre>
<p>Please note:</p>
<ul>
  <li>You should ensure that you register you services in the correct order of their dependency chain. Only dynamic references will be handled automatically independent of registration order.</li>
  <li>The injectServices, activate and deactivate Methods can only work properly when the SCR XML metadata files are preset in the classpath at <code>/OSGI-INF</code>. They are generated automatically by the Maven SCR plugin, but might be missing if your clean and build the project within your IDE (e.g. Eclipse). In this case you have to compile the project again with maven and can run the tests - or use a Maven IDE Integration like m2eclipse.</li>
</ul>
<h3>Provide your own configuration via ConfigAdmin</h3>
<p>If you want to provide your own configuration to an OSGi service that you do not register and activate itself in the mock context you can provide your own custom OSGi configuration via the mock implementation of the <code>ConfigAdmin</code> service.</p>
<p>Example:</p>
<pre><code>#!java

ConfigurationAdmin configAdmin = context.getService(ConfigurationAdmin.class);
Configuration myServiceConfig = configAdmin.getConfiguration(MY_SERVICE_PID);
Dictionary&lt;String, Object&gt; props = new Hashtable&lt;String, Object&gt;();
props.put(&quot;prop1&quot;, &quot;value1&quot;);
myServiceConfig.update(props);
</code></pre>
<h3>Context Plugins</h3>
<p>OSGi Mocks supports "Context Plugins" that hook into the lifecycle of each test run and can prepare test setup before or after the other setUp actions, and execute test tear down code before or after the other tearDown action.</p>
<p>To define a plugin implement the <code>org.apache.sling.testing.mock.osgi.context.ContextPlugin&lt;OsgiContextImpl&gt;</code> interface. For convenience it is recommended to extend the abstract class <code>org.apache.sling.testing.mock.osgi.context.AbstractContextPlugin&lt;OsgiContextImpl&gt;</code>. These plugins can be used with OSGi Mock context, but also with context instances deriving from it like Sling Mocks and AEM Mocks. In most cases you would just override the <code>afterSetUp</code> method. In this method you can register additional OSGi services or do other preparation work. It is recommended to define a constant pointing to a singleton of a plugin instance for using it.</p>
<p>To use a plugin in your unit test class, use the <code>OsgiContextBuilder</code> class instead of directly instantiating the <code>OsgiContext</code>class. This allows you in a fluent style to configure more options, with the <code>plugin(...)</code> method you can add one or more plugins.</p>
<p>Example: </p>
<pre><code>#!java
@Rule
public OsgiContext context = new OsgiContextBuilder().plugin(MY_PLUGIN).build();
</code></pre>
<p>More examples:</p>
<ul>
  <li><a href="https://github.com/apache/sling/blob/trunk/contrib/extensions/contextaware-config/testing/mocks/caconfig-mock-plugin/src/main/java/org/apache/sling/testing/mock/caconfig/ContextPlugins.java">Apache Sling Context-Aware Configuration Mock Plugin</a></li>
  <li><a href="https://github.com/apache/sling/blob/trunk/contrib/extensions/contextaware-config/testing/mocks/caconfig-mock-plugin/src/test/java/org/apache/sling/testing/mock/caconfig/ContextPluginsTest.java">Apache Sling Context-Aware Configuration Mock Plugin Test</a></li>
</ul></section></div></div>
<div class="footer">
                <div class="timestamp">
                    <lastmod>2017-06-27 19:33:27</lastmod>
                </div><div class="trademarkFooter">
                    Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
                </div>
            </div>            
            
        </div>
    </body>
</html>
