
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Sling - Everything is a Resource</TITLE>
    <LINK rel="stylesheet" href="http://incubator.apache.org/sling/site/media.data/site.css" type="text/css" media="all">
    <LINK rel="icon" href="http://incubator.apache.org/sling/site/media.data/favicon.ico">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY><div class="siteconversion">This is an old version of the Sling website, see the <a href="http://sling.apache.org/site-conversion.html">site conversion page</a> for more info.</div>
    <DIV class="title">
      <DIV class="logo">
        <A href="http://incubator.apache.org/sling/site/index.html">
          <IMG border="0" alt="Apache Sling" src="http://incubator.apache.org/sling/site/media.data/logo.png">
        </A>
      </DIV>
      <DIV class="header">
        <A href="http://incubator.apache.org/">
          <IMG border="0" alt="Apache Incubator" src="http://incubator.apache.org/images/apache-incubator-logo.png">
        </A>
      </DIV>
    </DIV>
    <DIV class="menu">
                                    <P>

<UL>
	<LI><A href="index.html" title="Index">Home</A></LI>
	<LI><A href="project-information.html" title="Project Information">Project Information</A></LI>
	<LI><A href="usecases.html" title="UseCases">Use Cases</A></LI>
	<LI><A href="guides.html" title="Guides">Guides</A></LI>
	<LI><A href="documentation.html" title="Documentation">Documentation</A></LI>
	<LI><A href="plugins.html" title="Plugins">Plugins</A></LI>
	<LI><A href="faq.html" title="FAQ">FAQ</A></LI>
	<LI><A href="links.html" title="Links">Links</A></LI>
	<LI><A href="old-documentation.html" title="Old Documentation">Old Documentation</A></LI>
	<LI><SPAN class="nobr"><A href="http://cwiki.apache.org/confluence/x/GAUB" title="Visit page outside Confluence" rel="nofollow">Wiki<SUP><IMG class="rendericon" src="http://cwiki.apache.org/confluence/images/icons/linkext7.gif" height="7" width="7" align="absmiddle" alt="" border="0"></SUP></A></SPAN></LI>
	<LI><SPAN class="nobr"><A href="http://www.apache.org/foundation/thanks.html" title="Visit page outside Confluence" rel="nofollow">Sponsors<SUP><IMG class="rendericon" src="http://cwiki.apache.org/confluence/images/icons/linkext7.gif" height="7" width="7" align="absmiddle" alt="" border="0"></SUP></A></SPAN></LI>
	<LI><SPAN class="nobr"><A href="http://www.apache.org/foundation/sponsorship.html" title="Visit page outside Confluence" rel="nofollow">Sponsorship<SUP><IMG class="rendericon" src="http://cwiki.apache.org/confluence/images/icons/linkext7.gif" height="7" width="7" align="absmiddle" alt="" border="0"></SUP></A></SPAN></LI>
</UL>


<P>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </DIV>
    <DIV class="main">
<H1><A name="EverythingisaResource-IntroducingtheSlingParadigm%3AEverythingisaResource"></A>Introducing the Sling Paradigm: Everything is a Resource</H1>



<P>Status: DRAFT<BR>
Created: 22. December 2007<BR>
Author: fmeschbe</P>

<DIV>
<UL>
  <LI><A href="#EverythingisaResource-1CurrentState">1 Current State</A></LI>
  <LI><A href="#EverythingisaResource-2EntertheSlingParadigm">2 Enter the Sling Paradigm</A></LI>
  <LI><A href="#EverythingisaResource-3ImplementingtheSlingParadigm">3 Implementing the Sling Paradigm</A>
<UL>
  <LI><A href="#EverythingisaResource-3.1ResourceProvisioning">3.1 Resource Provisioning</A></LI>
  <LI><A href="#EverythingisaResource-3.2Adapters">3.2 Adapters</A>
<UL>
  <LI><A href="#EverythingisaResource-3.2.1Adaptable">3.2.1 Adaptable</A></LI>
  <LI><A href="#EverythingisaResource-3.2.1SlingAdaptable">3.2.1 SlingAdaptable</A></LI>
  <LI><A href="#EverythingisaResource-3.2.1AdapterFactory">3.2.1 AdapterFactory</A></LI>
  <LI><A href="#EverythingisaResource-3.2.1AdapterManager">3.2.1 AdapterManager</A></LI>
</UL></LI>
  <LI><A href="#EverythingisaResource-3.3ChangeEvents">3.3 Change Events</A></LI>
  <LI><A href="#EverythingisaResource-3.4ResourceEnumeration">3.4 Resource Enumeration</A></LI>
</UL></LI>
  <LI><A href="#EverythingisaResource-4EmployingtheSlingParadigm">4 Employing the Sling Paradigm</A>
<UL>
  <LI><A href="#EverythingisaResource-4.1ResourcesinBundles">4.1 Resources in Bundles</A></LI>
  <LI><A href="#EverythingisaResource-4.2Servlets">4.2 Servlets</A></LI>
  <LI><A href="#EverythingisaResource-4.3Filters">4.3 Filters</A>
<UL>
  <LI><A href="#EverythingisaResource-4.3.1FilterServices">4.3.1 Filter Services</A></LI>
  <LI><A href="#EverythingisaResource-4.3.2FilterScripts">4.3.2 Filter Scripts</A></LI>
</UL></LI>
  <LI><A href="#EverythingisaResource-4.4ScriptsfromResource">4.4 Scripts from Resource</A></LI>
</UL></LI>
  <LI><A href="#EverythingisaResource-5ChangestotheCode">5 Changes to the Code</A>
<UL>
  <LI><A href="#EverythingisaResource-5.1SlingAPI">5.1 Sling API</A></LI>
  <LI><A href="#EverythingisaResource-5.2OSGiCommons">5.2 OSGi Commons</A></LI>
  <LI><A href="#EverythingisaResource-5.3Merge%257B%257Bscripting%252Fresolver%257D%257Dinto%257B%257Bsling%252Fservletresolver%257D%257D">5.3 Merge <TT>scripting/resolver</TT> into <TT>sling/servlet-resolver</TT></A></LI>
  <LI><A href="#EverythingisaResource-5.4SeparateObjectContentMappingfromResourceResolution">5.4 Separate Object Content Mapping from Resource Resolution</A></LI>
  <LI><A href="#EverythingisaResource-5.5EnhanceSlingConsole">5.5 Enhance Sling Console</A></LI>
  <LI><A href="#EverythingisaResource-5.6CreateNewAdapterProject">5.6 Create New Adapter Project</A></LI>
</UL></LI>
</UL></DIV>


<H2><A name="EverythingisaResource-1CurrentState"></A>1 Current State</H2>

<P>Currently Sling uses resources, servlets and scripts as follows:</P>

<UL>
	<LI>The <TT>Resource</TT> interface is mainly used to abstract JCR <TT>Node</TT> instances</LI>
	<LI>The <TT>ServletResolver</TT> uses an internal registration of servlets registered as OSGi services with the interface <TT>javax.servlet.Servlet</TT> and selects the servlet based on the resource type of the <TT>Resource</TT> of the request only.</LI>
	<LI>The <TT>ScriptResolver</TT> uses the <TT>ResourceResolver</TT> to find request handling scripts based on the resource type of the <TT>Resource</TT> of the request, the request selector string and the request method or request extension.</LI>
	<LI>Request processing filters are based on OSGi services registered with the interface name <TT>javax.servlet.Filter</TT></LI>
	<LI>Error handling is implemented in the <TT>ServletResolver</TT> implementation using the same mechanism to find a servlet (or script) based on the response status code or the caught <TT>Throwable</TT> as the pseudo request method name and using a different default error handling servlet.</LI>
</UL>


<P>This mechanism works rather good, but there are currently enhancement requests, which may not easily be implemented with the current concepts:</P>

<UL>
	<LI>Allow scripting of request processing filters. Implementing this requires special filter wrappers, which may select filter scripts.</LI>
	<LI>Enhance servlet selection to include the same parameters as script resolution, namely the request selector string and the request method or request extension. Implementing this would require replicating much of the code of the current <TT>ScriptResolver</TT> implementation.</LI>
</UL>



<H2><A name="EverythingisaResource-2EntertheSlingParadigm"></A>2 Enter the Sling Paradigm</H2>

<P>To overcome the limitations we introduce the Sling paradigm</P>

<DIV class="panel"><DIV class="panelContent">
<P>Everything is a Resource</P>
</DIV></DIV>

<P>The Sling paradigm brings the paradigm of Java Content Repository API (JCR) <EM>Everything is Content</EM> to Sling.</P>

<P>This means, that every script, servlet, filter, error handler, etc. is available from the <TT>ResourceResolver</TT> just like normal content providing data to be rendered upon requests. To enable this resource resolution and resources have to provide certain functionality:</P>

<UL>
	<LI>Allow registration of resources with the resource resolver. This is required to access servlets and filters registered as OSGi services through the resource resolver.</LI>
	<LI>Provide eventing mechanism to support caching and cache management</LI>
	<LI>Extend resource adapter mechanism, that is to provide extension to the <TT>Resource.adaptTo(Class&lt;?&gt;)</TT> method</LI>
	<LI>Extend resource enumeration to include resources from various sources</LI>
</UL>




<H2><A name="EverythingisaResource-3ImplementingtheSlingParadigm"></A>3 Implementing the Sling Paradigm</H2>

<H3><A name="EverythingisaResource-3.1ResourceProvisioning"></A>3.1 Resource Provisioning</H3>

<P>To be able to access resources from different locations through a single resource resolver, a new <TT>ResourceProvider</TT> interface is added. A resource provider is able to provide resources below a certain location in the (virtual) resource tree. The resource resolver selects a resource provider to ask for a resource looking for a longest match amongst the root paths of the providers. If the longest match resource provider cannot find the requested resource, the provider with the second longest match is asked, and so forth.</P>

<P>Accessing the JCR repository is also implemented in the form of a resource provider. This JCR resource provider is registered at the root &ndash; <TT>/</TT> &ndash; of the (virtual) resource tree. Thus the JCR repository is always asked if, no more specific resource provider has the requested resource.</P>

<P>The <TT>ResourceProvider</TT> interface is defined as follows:</P>

<DIV class="code"><DIV class="codeContent">
<PRE class="code-java"><SPAN class="code-keyword">package</SPAN> org.apache.sling.api.resource;

<SPAN class="code-keyword">public</SPAN> class ResourceProvider {

    /**
     * The name of the service registration property containing the root paths
     * of the resources provided by <SPAN class="code-keyword">this</SPAN> provider (value is <SPAN class="code-quote">&quot;provider.roots&quot;</SPAN>).
     */
    <SPAN class="code-keyword">static</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-object">String</SPAN> ROOTS = <SPAN class="code-quote">&quot;provider.roots&quot;</SPAN>;

    /**
     * Returns a resource from <SPAN class="code-keyword">this</SPAN> resource provider or &lt;code&gt;<SPAN class="code-keyword">null</SPAN>&lt;/code&gt; <SPAN class="code-keyword">if</SPAN>
     * the resource provider cannot find it. The path should have one of the
     * {@link #getRoots()} strings as its prefix.
     * &lt;p&gt;
     * This method is called to resolve a resource <SPAN class="code-keyword">for</SPAN> the given request. The
     * properties of the request, such as request parameters, may be use to
     * parametrize the resource resolution. An example of such parametrization
     * is support <SPAN class="code-keyword">for</SPAN> a JSR-311 style resource provider to support the
     * parametrized URL patterns.
     * 
     * @<SPAN class="code-keyword">throws</SPAN> SlingException may be thrown in <SPAN class="code-keyword">case</SPAN> of any problem creating the
     *             &lt;code&gt;Resource&lt;/code&gt; instance.
     */
    Resource getResource(/* ResourceResolver resourceResolver, */
          HttpServletRequest request, <SPAN class="code-object">String</SPAN> path) <SPAN class="code-keyword">throws</SPAN> SlingException;

    /**
     * Returns a resource from <SPAN class="code-keyword">this</SPAN> resource provider or &lt;code&gt;<SPAN class="code-keyword">null</SPAN>&lt;/code&gt; <SPAN class="code-keyword">if</SPAN>
     * the resource provider cannot find it. The path should have one of the
     * {@link #getRoots()} strings as its prefix.
     *
     * @<SPAN class="code-keyword">throws</SPAN> SlingException may be thrown in <SPAN class="code-keyword">case</SPAN> of any problem creating the
     *             &lt;code&gt;Resource&lt;/code&gt; instance.
     */
    Resource getResource(<SPAN class="code-object">String</SPAN> path) <SPAN class="code-keyword">throws</SPAN> SlingException;

    /**
     * Returns an &lt;code&gt;Iterator&lt;/code&gt; of {@link Resource} objects loaded
     * from the children of the given &lt;code&gt;Resource&lt;/code&gt;.
     * &lt;p&gt;
     * This method is only called <SPAN class="code-keyword">for</SPAN> resource providers whose root path list
     * contains an entry which is a prefix <SPAN class="code-keyword">for</SPAN> the path of the parent resource.
     * 
     * @param parent The {@link Resource Resource} whose children are requested.
     * @<SPAN class="code-keyword">return</SPAN> An &lt;code&gt;Iterator&lt;/code&gt; of {@link Resource} objects or
     *         &lt;code&gt;<SPAN class="code-keyword">null</SPAN>&lt;/code&gt; <SPAN class="code-keyword">if</SPAN> the resource provider has no children <SPAN class="code-keyword">for</SPAN>
     *         the given resource.
     * @<SPAN class="code-keyword">throws</SPAN> NullPointerException If &lt;code&gt;parent&lt;/code&gt; is
     *             &lt;code&gt;<SPAN class="code-keyword">null</SPAN>&lt;/code&gt;.
     * @<SPAN class="code-keyword">throws</SPAN> SlingException If any error occurs acquiring the child resource
     *             iterator.
     */
    Iterator&lt;Resource&gt; listChildren(Resource parent) <SPAN class="code-keyword">throws</SPAN> SlingException;
}</PRE>
</DIV></DIV>

<P>Resource providers are registered as OSGi services under the name <TT>org.apache.sling.api.resource.ResourceProvider</TT> providing the list of resource path roots as a service registration property with the name <TT>provider.roots</TT>.</P>


<H3><A name="EverythingisaResource-3.2Adapters"></A>3.2 Adapters</H3>

<P>The <TT>Resource</TT> and <TT>ResourceResolver</TT> interfaces are defined with a method <TT>adaptTo</TT>, which adapts the object to other classes. Using this mechanism the JCR session of the resource resolver calling the <TT>adaptTo</TT> method with the <TT>javax.jcr.Session</TT> class object. Likewise the node on which a resource is based can be retrieved by calling the <TT>Resource.adaptTo</TT> method with the <TT>javax.jcr.Node</TT> class object.</P>

<P>To use resources as scripts, the <TT>Resource.adaptTo</TT> method must support being called with the <TT>org.apache.sling.api.script.SlingScript</TT> class object. But of course, we do not want to integrate the script manager with the resource resolver. To enable adapting objects to classes which are not foreseen by the original implementation, a factory mechanism is used. This way, the script manager can provide an adapter factory to adapt <TT>Resource</TT> to <TT>SlingScript</TT> objects.</P>


<H4><A name="EverythingisaResource-3.2.1Adaptable"></A>3.2.1 Adaptable</H4>

<P>The <TT>Adaptable</TT> interface defines the API to be implemented by a class providing adaptability to another class. The single method defined by this interface is</P>

<DIV class="code"><DIV class="codeContent">
<PRE class="code-java">/**
 * Adapts the adaptable to another type.
 *
 * @param &lt;AdapterType&gt; The <SPAN class="code-keyword">generic</SPAN> type to which <SPAN class="code-keyword">this</SPAN> resource is adapted
 *            to
 * @param type The <SPAN class="code-object">Class</SPAN> object of the target type, such as
 *            &lt;code&gt;Node.class&lt;/code&gt;
 * @<SPAN class="code-keyword">return</SPAN> The adapter target or &lt;code&gt;<SPAN class="code-keyword">null</SPAN>&lt;/code&gt; <SPAN class="code-keyword">if</SPAN> the resource cannot
 *         adapt to the requested type
 */
&lt;AdapterType&gt; AdapterType adaptTo(<SPAN class="code-object">Class</SPAN>&lt;AdapterType&gt; type);</PRE>
</DIV></DIV>

<P>This method is called to get a view of the same object in terms of another class. Examples of implementations of this method is the Sling <TT>ResourceResolver</TT> implementation providing adapting to a JCR session and the Sling JCR based <TT>Resource</TT> implementation providing adapting to a JCR node.</P>


<H4><A name="EverythingisaResource-3.2.1SlingAdaptable"></A>3.2.1 SlingAdaptable</H4>

<P>The <TT>SlingAdaptable</TT> class is an implementation of the <TT>Adaptable</TT> interface, calls the <TT>AdapterManager</TT> (see below) to provider an adapter to the <TT>SlingAdaptable</TT> object to the requested class. This class may be extended to have extensible adapters not foreseen at the time of the class development.</P>

<P>An example of extending the <TT>SlingAdaptable</TT> class will be the Sling JCR based <TT>Resource</TT> implementation. This way, such a resource may be adapted to a <TT>SlingScript</TT> by means of an appropriatley programmed <TT>AdapterFactory</TT> (see below).</P>


<H4><A name="EverythingisaResource-3.2.1AdapterFactory"></A>3.2.1 AdapterFactory</H4>

<P>The <TT>AdapterFactory</TT> interface defines the service interface and API for factories supporting extensible adapters for <TT>SlingAdaptable</TT> objects. The interface has a single method:</P>

<DIV class="code"><DIV class="codeContent">
<PRE class="code-java">/**
 * Adapt the given adaptble object to the adaptable type. The adaptable
 * object is guaranteed to be an instance of one of the classes listed in
 * the {@link #ADAPTABLE_CLASSES} services registration property. The type
 * parameter is on of the classes listed in the {@link #ADAPTER_CLASSES}
 * service registration properties.
 *
 * @param &lt;AdapterType&gt;
 * @param adaptable
 * @param type
 * @<SPAN class="code-keyword">return</SPAN>
 */
&lt;AdapterType&gt; AdapterType getAdapter(<SPAN class="code-object">Object</SPAN> adaptable,
        <SPAN class="code-object">Class</SPAN>&lt;AdapterType&gt; type);</PRE>
</DIV></DIV>

<P>This method is called by the <TT>AdapterManager</TT> on behalf of the <TT>SlingAdaptable</TT> object providing the <TT>SlingAdaptable</TT> as the <TT>adaptable</TT> parameter the requested class as the <TT>type</TT> parameter. Implementations of this interface are registered as OSGi services providing two lists: The list of classes wich may be adapted and the list of classes to which the adapted class may be adapted.</P>


<H4><A name="EverythingisaResource-3.2.1AdapterManager"></A>3.2.1 AdapterManager</H4>

<P>The <TT>AdapterManager</TT> is an internal class used by the <TT>SlingAdaptable</TT> objects to find an <TT>AdapterFactory</TT> to delegate the <TT>adaptTo</TT> method call to. To make the <TT>AdapterManager</TT> available globally, it is actually defined as a service interface. Thus the adapter manager may be retrieved from the service registry to try to adapt whatever object that needs to be adapted - provided appropriate adapters exist.</P>

<P>The <TT>AdapterManager</TT> interface is defined as follows:</P>

<DIV class="code"><DIV class="codeContent">
<PRE class="code-java"><SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">interface</SPAN> AdapterManager {

    /**
     * Returns an adapter object of the requested &lt;code&gt;AdapterType&lt;/code&gt; <SPAN class="code-keyword">for</SPAN>
     * the given &lt;code&gt;adaptable&lt;/code&gt; object.
     * &lt;p&gt;
     * The &lt;code&gt;adaptable&lt;/code&gt; object may be any non-&lt;code&gt;<SPAN class="code-keyword">null</SPAN>&lt;/code&gt;
     * object and is not required to implement the &lt;code&gt;Adaptable&lt;/code&gt;
     * <SPAN class="code-keyword">interface</SPAN>.
     * 
     * @param &lt;AdapterType&gt; The <SPAN class="code-keyword">generic</SPAN> type of the adapter (target) type.
     * @param adaptable The object to adapt to the adapter type.
     * @param type The type to which the object is to be adapted.
     * @<SPAN class="code-keyword">return</SPAN> The adapted object or &lt;code&gt;<SPAN class="code-keyword">null</SPAN>&lt;/code&gt; <SPAN class="code-keyword">if</SPAN> no factory exists to
     *         adapt the &lt;code&gt;adaptable&lt;/code&gt; to the
     *         &lt;code&gt;AdapterType&lt;/code&gt; or <SPAN class="code-keyword">if</SPAN> the &lt;code&gt;adaptable&lt;/code&gt;
     *         cannot be adapted <SPAN class="code-keyword">for</SPAN> any other reason.
     */
    &lt;AdapterType&gt; AdapterType getAdapter(<SPAN class="code-object">Object</SPAN> adaptable,
            <SPAN class="code-object">Class</SPAN>&lt;AdapterType&gt; type);

}</PRE>
</DIV></DIV>



<H3><A name="EverythingisaResource-3.3ChangeEvents"></A>3.3 Change Events</H3>

<P>The Sling <TT>ResourceResolver</TT> implementation defines events to be fired on changes in the (virtual) resource tree:</P>

<UL>
	<LI>All repository events are forwarded</LI>
	<LI>Resource provider addition and removal events are generated</LI>
</UL>


<P>Events are transmitted using the OSGi EventTracker specification. That is interested parties must register as OSGi event listener services.</P>


<H3><A name="EverythingisaResource-3.4ResourceEnumeration"></A>3.4 Resource Enumeration</H3>

<P>To be help in development and debugging and also to merely visualize the (virtual) resource tree, the resource tree must be explorable. That is, for every resource, the method <TT>ResourceResolver.listChildren(Resource resource)</TT> method must return all resources which may be considered children of the given resource.</P>

<P>Consider for example the following (partial) repository:</P>

<DIV class="preformatted"><DIV class="preformattedContent">
<PRE>/
+-- filters
        +-- request
                +-- FilterA.esp
                +-- FilterB.jsp
</PRE>
</DIV></DIV>

<P>Further consider the filter <EM>FilterC</EM> registered as an OSGi service. Thus the <TT>listChildren</TT> call for the resource at <TT>/filters/request</TT> must return three resources <TT>/filters/request/FilterA.esp</TT>, <TT>/filters/request/FilterB.jsp</TT> and <TT>/filters/request/FilterC</TT>. The first two will be JCR based resources, while the latter will be  a servlet resource.</P>


<H2><A name="EverythingisaResource-4EmployingtheSlingParadigm"></A>4 Employing the Sling Paradigm</H2>

<H3><A name="EverythingisaResource-4.1ResourcesinBundles"></A>4.1 Resources in Bundles</H3>

<P>Resources may be located in OSGi bundles and mapped into the (virtual) resource tree by means of a <TT>BundleResourceProvider</TT>. Bundles containing resources indicate this fact by means of a special bundle manifest header: <TT>Sling-Bundle-Resources</TT>. Two notes regarding bundle resources:</P>

<OL>
	<LI>Bundle entries are either files or directories. To have these files and directories be handled as if they would be file and folder nodes in a repository, bundle based files will have a resource type <TT>nt:file</TT> and bundle based directories will have a resource type <TT>nt:folder</TT>.</LI>
	<LI>Bundle resource may be anything which may be represented by a file (or directory). That is the resources may be static content to be delivered to clients on request or resources may be scripts to be called to handle requests (or filter scripts even).</LI>
</OL>



<H3><A name="EverythingisaResource-4.2Servlets"></A>4.2 Servlets</H3>

<P>Servlets to be used for request processing are registered as OSGi services with a series of required service registration properties:</P>

<OL>
	<LI><TT>servlet.name</TT> - The name of the servlet as returned from <TT>ServletConfig.getServletName()</TT>. If this property is not set, the <TT>component.name</TT>, <TT>service.pid</TT> and <TT>service.id</TT> properties are checked in order.</LI>
	<LI><TT>servlet.path</TT> - A list of absolute paths under which the servlet is provided in the (virtual) resource tree.</LI>
	<LI><TT>sling.servlet.paths</TT> - The name of the service registration property of a Servlet registered as a service providing the absolute paths under which the servlet is accessible as a Resource (value is &quot;sling.servlet.paths&quot;). The type of this property is a String or String[] (array of strings) denoting the resource types.</LI>
	<LI><TT>sling.servlet.resourceTypes</TT> - The name of the service registration property of a Servlet registered as a service containing the resource type(s) supported by the servlet (value is &quot;sling.servlet.resourceTypes&quot;). The type of this property is a String or String[] (array of strings) denoting the resource types. This property is ignored if the <TT>SLING_SERVLET_PATHS</TT> property is set. Otherwise this property must be set or the servlet is ignored.</LI>
	<LI><TT>sling.servlet.selectors</TT> - The name of the service registration property of a Servlet registered as a service containing the request URL selectors supported by the servlet (value is &quot;sling.servlet.selectors&quot;). The selectors must be configured as they would be specified in the URL that is as a list of dot-separated strings such as <EM>print.a4</EM>. The type of this property is a String or String[] (array of strings) denoting the resource types. This property is ignored if the <TT>SLING_SERVLET_PATHS</TT> property is set. Otherwise this property is optional and ignored if not set.</LI>
	<LI><TT>sling.servlet.extensions</TT> - The name of the service registration property of a Servlet registered as a service containing the request URL extensions supported by the servlet for GET requests (value is &quot;sling.servlet.extensions&quot;). The type of this property is a String or String[] (array of strings) denoting the resource types. This property is ignored if the <TT>SLING_SERVLET_PATHS</TT> property is set. Otherwise this property or <TT>SLING_SERVLET_METHODS</TT> must be set or the servlet is ignored.</LI>
	<LI><TT>sling.servlet.methods</TT> - The name of the service registration property of a Servlet registered as a service containing the request methods supported by the servlet (value is &quot;sling.servlet.methods&quot;). The type of this property is a String or String[] (array of strings) denoting the resource types. This property is ignored if the <TT>SLING_SERVLET_PATHS</TT> property is set. Otherwise this property or <TT>SLING_SERVLET_EXTENSIONS</TT> must be set or the servlet is ignored.</LI>
</OL>



<P>A <TT>SlingServletResolver</TT> will listen for <TT>Servlet</TT> services and - given the correct service registration properties - provide the servlets as resources in the (virtual) resource tree. Such servlets are provided as <TT>ServletResource</TT> instances which adapt to the <TT>javax.servlet.Servlet</TT> class.</P>


<H3><A name="EverythingisaResource-4.3Filters"></A>4.3 Filters</H3>

<P>Filters may be provided in two different ways: As <TT>javax.servlet.Filter</TT> instances registered as OSGi services and as scripts located in a predefined place. When requests are processed the filters are looked up in the (virtual) resource tree below the <TT>/filters</TT> node. The list of filters is comprised of all the filters directly below the respective scope &ndash; <EM>request</EM> or <EM>resource</EM> &ndash; and the those below the respective scope and the type of the resource of the request.</P>

<P>The filters are sorted by their names. Hence a convention for the names of the filters in the (virtual) resource tree is defined such that the names is composed of an ordering number and the actual filter name, e.g. <EM>0&#95;sample</EM>.</P>

<H4><A name="EverythingisaResource-4.3.1FilterServices"></A>4.3.1 Filter Services</H4>

<P>Filters registered as OSGi services have three required service registration properties:</P>

<OL>
	<LI><TT>filter.scope</TT> - (String) Scope of the filter, which must be either <EM>request</EM> or <EM>resource</EM></LI>
	<LI><TT>filter.order</TT> - (Integer) Call order of the filter used to define the filter call sequence</LI>
	<LI><TT>filter.name</TT> - (String) The name of the filter as returned <TT>FilterConfig.getFilterName()</TT>. If this property is not set, the <TT>component.name</TT>, <TT>service.pid</TT> and <TT>service.id</TT> properties are checked in order.</LI>
	<LI><TT>filter.resource.type</TT> - (String[]) The list of resource types to which this filter applies. This property is optional. If missing, the filter applies to all resource types. If this property is an empty list, the filter is not used as it applies to an empty list of resource types.</LI>
</OL>


<P>Such Filter services are added to the (virtual) resource tree at a path defined as follows for each resource type <TT>resource_type</TT> listed in the <TT>filter.resource.type</TT>.</P>

<DIV class="code"><DIV class="codeContent">
<PRE class="code-java">/filters/${filter.scope}/${resource_type}/${filter.order}_${filter.name}</PRE>
</DIV></DIV>

<P>If the <TT>filter.resource.type</TT> property is missing, the filter is added at</P>

<DIV class="code"><DIV class="codeContent">
<PRE class="code-java">/filters/${filter.scope}/${filter.order}_${filter.name}</PRE>
</DIV></DIV>


<H4><A name="EverythingisaResource-4.3.2FilterScripts"></A>4.3.2 Filter Scripts</H4>

<P>Filter scripts may just be added as resources in the JCR repository at the appropriate location. For example for a request level filter applicable to <TT>nt:file</TT> nodes only, the filter would be placed in the <TT>/filters/request/nt/file</TT> folder.</P>


<H3><A name="EverythingisaResource-4.4ScriptsfromResource"></A>4.4 Scripts from Resource</H3>

<P>A <TT>Resource</TT> returned from the resource resolver may be a script. The script manager registers an <TT>AdapterFactory</TT> to adapt <TT>Resource</TT> to <TT>SlingScript</TT>. This factory will resolve a script engine for the resource file extension and return a <TT>SlingScript</TT> instance based on the <TT>Resource</TT>. If no script engine exists, the <TT>Resource</TT> may not be adapted.</P>

<P>The <TT>AdapterFactory</TT> adapting to a <TT>SlingScript</TT> is also able to adapt to <TT>Servlet</TT> by wrapping the adapted <TT>SlingScript</TT> in a <TT>ScriptServlet</TT>.</P>


<P>h3 4.5 Object Content Mapping</P>

<P>To cope with the new extensible functionality based on the <TT>SlingAdaptable</TT> class and adapter factories, object content mapping cannot be hard coded to just respond to any class. Instead, the Object Content Mapping functionality is in fact provided in terms of adapter factories, which are registered to be able to adapt instances the <TT>Resource</TT> interface to predefined types.</P>

<P>This way, Object Content Mapping takes part in adapter resolution just like any extensible adaption.</P>

<P>As a consequence, Object Content Mapping may probable be taken out of the current <TT>jcr/resource</TT> project into its own project.</P>


<H2><A name="EverythingisaResource-5ChangestotheCode"></A>5 Changes to the Code</H2>


<H3><A name="EverythingisaResource-5.1SlingAPI"></A>5.1 Sling API</H3>

<OL>
	<LI>Add <TT>org.apache.sling.api.adapter.Adaptable</TT> interface</LI>
	<LI><TT>Resource</TT> and <TT>RespourceResolver</TT> interfaces extend the <TT>Adaptable</TT> interface</LI>
	<LI>Add <TT>org.apache.sling.api.resource.ResourceProvider</TT> interface</LI>
	<LI>Merge <TT>SlingScriptResolver</TT> and <TT>ServletResolver</TT></LI>
	<LI>Add <TT>AdapterFactory</TT> and <TT>AdapterManager</TT> service interfaces</LI>
</OL>


<H3><A name="EverythingisaResource-5.2OSGiCommons"></A>5.2 OSGi Commons</H3>

<P>The <TT>org.apache.sling.osgi.commons</TT> bundle is a new project providing the following functionality:</P>

<UL>
	<LI><TT>ServiceLocator</TT> implementation (moved from <TT>sling/core</TT> project</LI>
</UL>


<H3><A name="EverythingisaResource-5.3Merge%7B%7Bscripting%2Fresolver%7D%7Dinto%7B%7Bsling%2Fservletresolver%7D%7D"></A>5.3 Merge <TT>scripting/resolver</TT> into <TT>sling/servlet-resolver</TT></H3>

<P>The <TT>SlingScriptResolver</TT> and  <TT>ServletResolver</TT> interfaces are merged into a single <TT>ServletResolver</TT> interface, which has a <TT>resolve(SlingHttpServletRequest)</TT> and a <TT>find(ResourceResolver, String relPath)</TT> method. The implementation of this method will apply the alogirthm of the current <TT>scripting/resolver</TT> implementation of the <TT>SlingScriptResolver</TT>.</P>

<P>Any script (or servlet or actually code) may call any script or servlet by just resolving the script or servlet to a <TT>Resource</TT> and adapting the resource found to a <TT>SlingScript</TT> or <TT>Servlet</TT>.</P>


<H3><A name="EverythingisaResource-5.4SeparateObjectContentMappingfromResourceResolution"></A>5.4 Separate Object Content Mapping from Resource Resolution</H3>

<P>By applying the mechanisms of adapter factories, Object Content Mapping can be broken out of the <TT>jcr/resource</TT> project into its own project <TT>jcr/ocm</TT>.</P>


<H3><A name="EverythingisaResource-5.5EnhanceSlingConsole"></A>5.5 Enhance Sling Console</H3>

<P>Provide a Sling Console enhancement to explore the (virtual) resource tree</P>


<H3><A name="EverythingisaResource-5.6CreateNewAdapterProject"></A>5.6 Create New Adapter Project</H3>

<P>A new Adapter project <TT>sling/adapter</TT> takes the following classes:</P>

<UL>
	<LI><TT>SlingAdaptable</TT> class implementing <TT>Adaptable</TT> and leveraging adapter factories</LI>
	<LI>Implementation of the <TT>AdapterManager</TT> service also used by <TT>SlingAdaptable</TT> class</LI>
</UL>

    </DIV>
  </BODY>
</HTML>

