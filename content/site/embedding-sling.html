
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Sling - Embedding Sling</TITLE>
    <LINK rel="stylesheet" href="http://sling.apache.org/site/media.data/site.css" type="text/css" media="all">
    <LINK rel="icon" href="http://sling.apache.org/site/media.data/favicon.ico">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY><div class="siteconversion">This is an old version of the Sling website, see the <a href="http://sling.apache.org/site-conversion.html">site conversion page</a> for more info. The migrated but not yet edited version of this page is at <a href='/documentation/development/embedding-sling.html'>/documentation/development/embedding-sling.html</a></div>
    <DIV class="title">
      <DIV class="logo">
        <A href="http://sling.apache.org/site/index.html">
          <IMG border="0" alt="Apache Sling" src="http://sling.apache.org/site/media.data/logo.png">
        </A>
      </DIV>
      <DIV class="header">
        <A href="http://www.apache.org/">
          <IMG border="0" alt="Apache" src="http://sling.apache.org/site/media.data/apache.png">
        </A>
      </DIV>
    </DIV>
    <DIV class="menu">
<P><B>Documentation</B><BR class="atl-forced-newline">
<A href="getting-started.html" title="Getting Started">Getting Started</A><BR class="atl-forced-newline">
<A href="the-sling-engine.html" title="The Sling Engine">The Sling Engine</A><BR class="atl-forced-newline">
<A href="development.html" title="Development">Development</A><BR class="atl-forced-newline">
<A href="bundles.html" title="Bundles">Bundles</A><BR class="atl-forced-newline">
<A href="tutorials-how-tos.html" title="Tutorials & How-Tos">Tutorials &amp; How&#45;Tos</A><BR class="atl-forced-newline">
<A href="configuration.html" title="Configuration">Configuration</A><BR class="atl-forced-newline">
<A href="http://sling.apache.org/apidocs/sling6/index.html" class="external-link" rel="nofollow">API docs</A><BR class="atl-forced-newline">
<A href="http://s.apache.org/sling.wiki" class="external-link" rel="nofollow">Wiki</A><BR class="atl-forced-newline">
<A href="http://s.apache.org/sling.faq" class="external-link" rel="nofollow">FAQ</A><BR class="atl-forced-newline"></P>

<P><B>Project info</B><BR class="atl-forced-newline">
<A href="http://sling.apache.org/site/downloads.cgi" class="external-link" rel="nofollow">Downloads</A><BR class="atl-forced-newline">
<A href="http://www.apache.org/licenses/" class="external-link" rel="nofollow">License</A><BR class="atl-forced-newline">
<A href="contributing.html" title="Contributing">Contributing</A><BR class="atl-forced-newline">
<A href="news.html" title="News">News</A><BR class="atl-forced-newline">
<A href="links.html" title="Links">Links</A><BR class="atl-forced-newline">
<A href="project-information.html" title="Project Information">Project Information</A><BR class="atl-forced-newline">
<A href="https://issues.apache.org/jira/browse/SLING" class="external-link" rel="nofollow">Issue Tracker</A><BR class="atl-forced-newline">
<A href="http://svn.apache.org/viewvc/sling/trunk" class="external-link" rel="nofollow">Browse Source Repository</A><BR class="atl-forced-newline">
<A href="security.html" title="Security">Security</A><BR class="atl-forced-newline"></P>

<P><B>Sponsorship</B><BR class="atl-forced-newline">
<A href="http://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">Thanks</A><BR class="atl-forced-newline">
<A href="http://www.apache.org/foundation/sponsorship.html" class="external-link" rel="nofollow">Become a Sponsor</A><BR>
<A href="http://www.apache.org/foundation/buy_stuff.html" class="external-link" rel="nofollow">Buy Stuff</A></P>


  <IFRAME src="http://www.apache.org/ads/button.html" style="border-width:0; float: left" frameborder="0" scrolling="no" width="135" height="135"></IFRAME>
  <P style="height: 135px"></P>
    </DIV>
    <DIV class="main">
        <DIV class="breadcrump" style="font-size: 80%;">
<A href="apache-sling.html" title="Apache Sling Website">Apache Sling Website</A>&nbsp;&gt;&nbsp;<A href="apache-sling.html" title="Apache Sling">Apache Sling</A>&nbsp;&gt;&nbsp;<A href="documentation.html" title="Documentation">Documentation</A>&nbsp;&gt;&nbsp;<A href="development.html" title="Development">Development</A>&nbsp;&gt;&nbsp;<A href="" title="Embedding Sling">Embedding Sling</A>
        </DIV>
<H1><A name="EmbeddingSling-EmbeddingSling"></A>Embedding Sling</H1>

<P>The Sling Launchpad Launcher can be used to embed the OSGi Framework startup in your own Java application. This functionality is implemented in the <A href="http://svn.apache.org/repos/asf/sling/trunk/launchpad/base" class="external-link" rel="nofollow">Sling Launchpad Base project</A>. This project has the following features:</P>

<UL>
	<LI>Builds three artifacts:
	<UL>
		<LI>A standalone Java Application with the artifact qualifier <EM>app</EM>; e.g. <TT>org.apache.sling.launchpad.base-2.3.1-SNAPSHOT-app.jar</TT></LI>
		<LI>A Web Application with the artifact qualifier <EM>webapp</EM>; e.g <TT>org.apache.sling.launchpad.base-2.3.1-SNAPSHOT-wepabb.war</TT></LI>
		<LI>The primary artifact without an artifact qualifier; e.g. <TT>org.apache.sling.launchpad.base-2.3.1-SNAPSHOT.jar</TT></LI>
	</UL>
	</LI>
	<LI>Embeds the OSGi Framework (Apache Felix) in the primary artifact</LI>
	<LI>Encapsulates the OSGi Framework in its own <TT>URLClassLoader</TT></LI>
	<LI>Supports Framework restart</LI>
	<LI>Allows propagation of core setup functionality depending on the environment</LI>
</UL>


<P>This page is about the internal details of the Sling Launchpad Base module. To get an outside overview of the Sling Launchpad you might want to refer to <A href="the-sling-launchpad.html" title="The Sling Launchpad">The Sling Launchpad</A> page.</P>

<H1><A name="EmbeddingSling-Structure"></A>Structure</H1>

<P>The Launcher is based on three parts:</P>
<OL>
	<LI>The external part which is for example the standalone Java application's main class or the servlet deployed into the servlet container</LI>
	<LI>The internal part which is the OSGi framework plus helper classes to control the framework and run initial installations</LI>
	<LI>The bridging part, which contains API common to the external and internal part.</LI>
</OL>


<P>The external part uses the bridging part to create the class loader into which the internal part is loaded. The bidirectional communication between the external and internal part is implement based on two interfaces:</P>

<UL>
	<LI>The <TT>Launcher</TT> interface is implemented by a class in the internal part which is loaded through the bridge class loader. This interface allows setting, starting and stopping of the framework.</LI>
	<LI>The <TT>Notifiable</TT> interface is implemented by a class in the external part which instance is handed to the <TT>Launcher</TT> instance. This interface allows the internal part to communicate back to the external part, most notably to indicate that the framework has been stopped from within or that the framework has been updated and must be restarted.</LI>
</UL>



<H1><A name="EmbeddingSling-TheBridgingPart"></A>The Bridging Part</H1>

<P>The bridging part is provided in the <TT>org.apache.sling.launchpad.base.shared</TT> package:</P>

<DIV class="table-wrap">
<TABLE class="confluenceTable"><TBODY>
<TR>
<TD class="confluenceTd"> Class </TD>
<TD class="confluenceTd"> Description </TD>
</TR>
<TR>
<TD class="confluenceTd"> Launcher </TD>
<TD class="confluenceTd"> The interface implemented by the internal class matching the external class being called to start/stop the framework. </TD>
</TR>
<TR>
<TD class="confluenceTd"> LauncherClassLoader </TD>
<TD class="confluenceTd"> <TT>URLClassLoader</TT> implementing the class loader to load the internal part (along with the OSGi framework). This class loader only delegates to the parent class loader any packages not contained in the launchpad library (primary artifact of the Launchpad Base project). </TD>
</TR>
<TR>
<TD class="confluenceTd"> Loader </TD>
<TD class="confluenceTd"> Helper class to find the launchpad library and to create the <TT>LauncherClassLoader</TT> with that library. This class is also used to actually load the <TT>Launcher</TT> implementation to be called from the external launcher class. </TD>
</TR>
<TR>
<TD class="confluenceTd"> Notifiable </TD>
<TD class="confluenceTd"> The interface implemented in the external part and handed over to the internal part. </TD>
</TR>
<TR>
<TD class="confluenceTd"> SharedConstants </TD>
<TD class="confluenceTd"> Constants naming various properties and classes. </TD>
</TR>
</TBODY></TABLE>
</DIV>



<H1><A name="EmbeddingSling-TheInternalPart"></A>The Internal Part</H1>

<P>The main class from the internal class directly used is <A href="http://svn.apache.org/repos/asf/sling/trunk/launchpad/base/src/main/java/org/apache/sling/launchpad/base/impl/Sling.java" class="external-link" rel="nofollow"><TT>Sling</TT></A> which instantiated to start the OSGi Framework. This class is responsible for setting up the environment to finally start the OSGi Framework:</P>

<UL>
	<LI>Read the <TT>sling.properties</TT> file</LI>
	<LI>Ensure the presence of the JMX MBeanServer service</LI>
	<LI>Execute the bootstrap installations, updates and uninstallations</LI>
</UL>


<P>The <A href="http://svn.apache.org/repos/asf/sling/trunk/launchpad/base/src/main/java/org/apache/sling/launchpad/base/impl/SlingFelix.java" class="external-link" rel="nofollow"><TT>SlingFelix</TT></A> class extends the Apache Felix <TT>Felix</TT> class which is the actual OSGi framework implementation. We extend the class to be able to notify the <TT>Notifiable</TT> implementation and update the OSGi framework from within the OSGi framework by updating the system bundle.</P>


<H2><A name="EmbeddingSling-TheExternalPart"></A>The External Part</H2>

<P>The external part is comprised of a main class started from the environment &ndash; main class of the Java applicaction or the servlet deployed in the servlet container &ndash; and a corresponding delegate class located inside of the launchpad base library. This delegate class is instantiated by the <TT>Loader</TT> loading from the <TT>LauncherClassLoader</TT>.</P>


<H3><A name="EmbeddingSling-StandaloneJavaApplication"></A>Standalone Java Application</H3>

<P>The standalone Java Application makes use of three classes:</P>

<DIV class="table-wrap">
<TABLE class="confluenceTable"><TBODY>
<TR>
<TD class="confluenceTd"> Class </TD>
<TD class="confluenceTd"> Description </TD>
</TR>
<TR>
<TD class="confluenceTd"> Main </TD>
<TD class="confluenceTd"> This is the main class whose <TT>main</TT> method is called by the Java VM. This class is itself the <TT>Notifiable</TT> and finds the <TT>sling.home</TT> location from the environment (command line parameter, system property, or environment variable). </TD>
</TR>
<TR>
<TD class="confluenceTd"> MainDelegate </TD>
<TD class="confluenceTd"> This class is loaded by the <TT>Loader</TT> from the <TT>LauncherClassLoader</TT> to actually complete the initial setup before creating the <TT>Sling</TT> class to start the framework. </TD>
</TR>
<TR>
<TD class="confluenceTd"> ControlListener </TD>
<TD class="confluenceTd"> This class is used by the <TT>Main</TT> class to open a server socket to be able to start and stop Sling as a server. This class allows for starting (opening the server socket), status check (connecting to the socket asking for status), and shutdown (connecting to the socket asking for shutdown). </TD>
</TR>
</TBODY></TABLE>
</DIV>


<P>At the moment these classes are not directly suitable to be embedded in an existing application (or custom application launcher framework) unless that embedding prepares command line arguments in a <TT>String[]</TT> and calls the <TT>Main.main</TT> method. To allow for custom embeddings or extensions, the work distriubtions between the three classes should be refactored.</P>

<H3><A name="EmbeddingSling-EmbeddingtheStandaloneJavaApplication"></A>Embedding the Standalone Java Application</H3>

<DIV class="panelMacro"><TABLE class="infoMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><IMG src="https://cwiki.apache.org/confluence/images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD>This work is being done as part of <A href="https://issues.apache.org/jira/browse/SLING-2225" class="external-link" rel="nofollow">SLING-2225</A> and will be officially available with the Sling Launchpad Base release 2.4.0. If you want to use the embedding before the release, you have to checkout the source from <A href="http://svn.apache.org/repos/asf/sling/trunk/launchpad/base" class="external-link" rel="nofollow">SVN</A> and build yourself.</TD></TR></TABLE></DIV>

<P>To embedd the Sling Launcher in an application, the <TT>Main</TT> class is extended from. To manage the launcher, the following API is available:</P>

<DIV class="table-wrap">
<TABLE class="confluenceTable"><TBODY>
<TR>
<TH class="confluenceTh"> Method </TH>
<TH class="confluenceTh"> Description </TH>
</TR>
<TR>
<TD class="confluenceTd"> <TT>Main(Map&lt;String, String&gt; properties)</TT> </TD>
<TD class="confluenceTd"> Instantiates the Main class with the given configuration properties. These are properties which are used directly as overwrites to the configurations in the <TT>sling.properties</TT> file. There is no more conversion applied. </TD>
</TR>
<TR>
<TD class="confluenceTd"> <TT>doControlCommand()</TT> </TD>
<TD class="confluenceTd"> Before starting the application for the first time, this method can be called to handle any control command action. </TD>
</TR>
<TR>
<TD class="confluenceTd"> <TT>doStart()</TT> </TD>
<TD class="confluenceTd"> Starts the Sling Application using the provided configuration properties as overwrites. Also these properties (or the <TT>sling.home</TT> system property or the <TT>SLING_HOME</TT> environment variable are analyzed to get the value for the <TT>sling.home</TT> setting. </TD>
</TR>
<TR>
<TD class="confluenceTd"> <TT>doStop()</TT> </TD>
<TD class="confluenceTd"> Stops the application started by the <TT>doStart()</TT> method. </TD>
</TR>
</TBODY></TABLE>
</DIV>



<H4><A name="EmbeddingSling-ExternalControloftheSlingApplication"></A>External Control of the Sling Application</H4>

<P>By using control actions, the Sling Launcher may open or connect to a control port to communicate. The <TT>doControlAction()</TT> method together with the <TT>sling.control.action</TT> and <TT>sling.control.socket</TT> properties is able to setup this communication.</P>

<P>The <TT>sling.control.socket</TT> is either a normal port number, in which case the connection is opened on the <TT>localhost</TT> interface (usually 127.0.0.1). Otheriwse, it may also be a value of the form <EM>host:port</EM> where <EM>host</EM> is the name or IP address of the interface to connect to and port is the port number. For security reasons it is suggested to not use an interface which is available remotely. So the default of <TT>localhost</TT> is usually the best choice.</P>

<P>The <TT>sling.control.action</TT> takes either of three values:</P>

<DIV class="table-wrap">
<TABLE class="confluenceTable"><TBODY>
<TR>
<TD class="confluenceTd"> <TT>start</TT> </TD>
<TD class="confluenceTd"> Starts a server socket as specified by the <TT>sling.control.socket</TT> property. If the socket cannot be bound to (because the port is in use) an error message is printed. Using the <TT>start</TT> action only makes sense when starting the application. </TD>
</TR>
<TR>
<TD class="confluenceTd"> <TT>stop</TT> </TD>
<TD class="confluenceTd"> The <TT>stop</TT> action is used to stop a running application. For that a connection is opened to the server running on the socket specified by the <TT>sling.control.socket</TT> property. On this connection the server is instructed to shut down. After executing the <TT>stop</TT> action, the Java application should be terminated. </TD>
</TR>
<TR>
<TD class="confluenceTd"> <TT>status</TT> </TD>
<TD class="confluenceTd"> The <TT>status</TT> action is used to check the status of a running application. For that a connection is opened to the server running on the socket specified by the <TT>sling.control.socket</TT> property. On this connection the server is queried on its status. After executing the <TT>stop</TT> action, the Java application should be terminated. </TD>
</TR>
</TBODY></TABLE>
</DIV>



<H4><A name="EmbeddingSling-ConversionofCommandlineArgumentstoProperties"></A>Conversion of Commandline Arguments to Properties</H4>

<P>When calling the Main class through the JVM startup the <TT>Main.main(String[] args)</TT> methods is called which reads the command line arguments and converts them into a <TT>Map&lt;String, String&gt;</TT> suitable for the constructore as follows:</P>

<DIV class="table-wrap">
<TABLE class="confluenceTable"><TBODY>
<TR>
<TH class="confluenceTh"> Command Line Argument </TH>
<TH class="confluenceTh"> Properties Entry </TH>
</TR>
<TR>
<TD class="confluenceTd"> start </TD>
<TD class="confluenceTd"> sling.control.action = &quot;start&quot; </TD>
</TR>
<TR>
<TD class="confluenceTd"> status </TD>
<TD class="confluenceTd"> sling.control.action = &quot;status&quot; </TD>
</TR>
<TR>
<TD class="confluenceTd"> stop </TD>
<TD class="confluenceTd"> sling.control.action = &quot;stop&quot; </TD>
</TR>
<TR>
<TD class="confluenceTd"> -c slinghome </TD>
<TD class="confluenceTd"> sling.home = slinghome </TD>
</TR>
<TR>
<TD class="confluenceTd"> -l loglevel </TD>
<TD class="confluenceTd"> org.apache.sling.commons.log.level = loglevel </TD>
</TR>
<TR>
<TD class="confluenceTd"> -f logfile </TD>
<TD class="confluenceTd"> org.apache.sling.commons.log.file = logfile </TD>
</TR>
<TR>
<TD class="confluenceTd"> -a address </TD>
<TD class="confluenceTd"> This command line argument is not supported yet and thus ignored </TD>
</TR>
<TR>
<TD class="confluenceTd"> -p port </TD>
<TD class="confluenceTd"> org.osgi.service.http.port = port </TD>
</TR>
<TR>
<TD class="confluenceTd"> -j [ host &quot;:&quot; ] port </TD>
<TD class="confluenceTd"> sling.control.socket = [ host &quot;:&quot; ] port </TD>
</TR>
<TR>
<TD class="confluenceTd"> -h </TD>
<TD class="confluenceTd"> This command line option is handled directly and not converted into the map </TD>
</TR>
</TBODY></TABLE>
</DIV>



<H3><A name="EmbeddingSling-WebApplication"></A>Web Application</H3>

<P>The web application makes use of 5 classes:</P>

<DIV class="table-wrap">
<TABLE class="confluenceTable"><TBODY>
<TR>
<TD class="confluenceTd"> Class </TD>
<TD class="confluenceTd"> Description </TD>
</TR>
<TR>
<TD class="confluenceTd"> SlingServlet </TD>
<TD class="confluenceTd"> This is the servlet registered in the <TT>web.xml</TT> descriptor and loaded by the servlet container into which Sling is deplyoed. This class locates the <TT>sling.home</TT> folder and loads the <TT>SlingServletDelagate</TT> to actually launch the framework. </TD>
</TR>
<TR>
<TD class="confluenceTd"> SlingSessionListener </TD>
<TD class="confluenceTd"> This &ndash; somewhat inappropriately named &ndash; class is registered as a listener by the Sling <TT>web.xml</TT> descriptor. It is called by the servlet container and forwards events to the <TT>SlingHttpSessionListenerDelegate</TT> which in turn forwards the events to the respective Servlet API listener services registered in the OSGi Framework. </TD>
</TR>
<TR>
<TD class="confluenceTd"> SlingBridge </TD>
<TD class="confluenceTd"> Simple extension of the <TT>Sling</TT> class which registers the system bundle's <TT>BundleContext</TT> as a servlet context attribute of the Sling web application. This allows Servlet Container bridging to properly work. </TD>
</TR>
<TR>
<TD class="confluenceTd"> SlingHttpSessionListenerDelegate </TD>
<TD class="confluenceTd"> This class is loaded by the <TT>LauncherClassLoader</TT> called from the <TT>SlingSessionListener</TT>. It is called by the <TT>SlingSessionListener</TT> to forward servlet container events to registered Servlet API listener services. </TD>
</TR>
<TR>
<TD class="confluenceTd"> SlingServletDelegate </TD>
<TD class="confluenceTd"> This class is loaded by the <TT>Loader</TT> from the <TT>LauncherClassLoader</TT> to actually complete the initial setup before creating the <TT>SlingBridge</TT> class to start the framework. </TD>
</TR>
</TBODY></TABLE>
</DIV>


<P>At the moment these classes, particularly the <TT>SlingServlet</TT> class, are not particularly well suited to be extended by a servlet slightly modifying the launcher.</P>
        <DIV class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
Last modified by fmeschbe on 2011-09-24 09:12:01.0
        </DIV>
        <DIV class="trademarkFooter">
Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
        </DIV>
    </DIV>
  </BODY>
</HTML>

