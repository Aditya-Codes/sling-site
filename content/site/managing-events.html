
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Sling - Managing events</TITLE>
    <LINK rel="stylesheet" href="http://sling.apache.org/site/media.data/site.css" type="text/css" media="all">
    <LINK rel="icon" href="http://sling.apache.org/site/media.data/favicon.ico">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY><div class="siteconversion">This is an old version of the Sling website, see the <a href="http://sling.apache.org/site-conversion.html">site conversion page</a> for more info.</div>
    <DIV class="title">
      <DIV class="logo">
        <A href="http://sling.apache.org/site/index.html">
          <IMG border="0" alt="Apache Sling" src="http://sling.apache.org/site/media.data/logo.png">
        </A>
      </DIV>
      <DIV class="header">
        <A href="http://www.apache.org/">
          <IMG border="0" alt="Apache" src="http://sling.apache.org/site/media.data/apache.png">
        </A>
      </DIV>
    </DIV>
    <DIV class="menu">
<P><B>Documentation</B><BR class="atl-forced-newline">
<A href="getting-started.html" title="Getting Started">Getting Started</A><BR class="atl-forced-newline">
<A href="the-sling-engine.html" title="The Sling Engine">The Sling Engine</A><BR class="atl-forced-newline">
<A href="development.html" title="Development">Development</A><BR class="atl-forced-newline">
<A href="bundles.html" title="Bundles">Bundles</A><BR class="atl-forced-newline">
<A href="tutorials-how-tos.html" title="Tutorials & How-Tos">Tutorials &amp; How&#45;Tos</A><BR class="atl-forced-newline">
<A href="configuration.html" title="Configuration">Configuration</A><BR class="atl-forced-newline">
<A href="http://sling.apache.org/apidocs/sling5/index.html" class="external-link" rel="nofollow">API docs</A><BR class="atl-forced-newline">
<A href="http://s.apache.org/sling.wiki" class="external-link" rel="nofollow">Wiki</A><BR class="atl-forced-newline">
<A href="http://s.apache.org/sling.faq" class="external-link" rel="nofollow">FAQ</A><BR class="atl-forced-newline"></P>

<P><B>Project info</B><BR class="atl-forced-newline">
<A href="http://sling.apache.org/site/downloads.cgi" class="external-link" rel="nofollow">Downloads</A><BR class="atl-forced-newline">
<A href="contributing.html" title="Contributing">Contributing</A><BR class="atl-forced-newline">
<A href="news.html" title="News">News</A><BR class="atl-forced-newline">
<A href="links.html" title="Links">Links</A><BR class="atl-forced-newline">
<A href="project-information.html" title="Project Information">Project Information</A><BR class="atl-forced-newline"></P>

<P><B>Sponsorship</B><BR class="atl-forced-newline">
<A href="http://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">Thanks</A><BR class="atl-forced-newline">
<A href="http://www.apache.org/foundation/sponsorship.html" class="external-link" rel="nofollow">Become a Sponsor</A><BR>
<A href="http://www.apache.org/foundation/buy_stuff.html" class="external-link" rel="nofollow">Buy Stuff</A></P>


  <IFRAME src="http://www.apache.org/ads/button.html" style="border-width:0; float: left" frameborder="0" scrolling="no" width="135" height="135"></IFRAME>
  <P style="height: 135px"></P>
    </DIV>
    <DIV class="main">
        <DIV class="breadcrump" style="font-size: 80%;">
<A href="apache-sling.html" title="Apache Sling Website">Apache Sling Website</A>&nbsp;&gt;&nbsp;<A href="apache-sling.html" title="Apache Sling">Apache Sling</A>&nbsp;&gt;&nbsp;<A href="documentation.html" title="Documentation">Documentation</A>&nbsp;&gt;&nbsp;<A href="tutorials-how-tos.html" title="Tutorials & How-Tos">Tutorials &amp; How-Tos</A>&nbsp;&gt;&nbsp;<A href="" title="Managing events">Managing events</A>
        </DIV>
<P>Apache Sling provides some mechanisms and support for managing events. This page describes ...</P>

<P>Sling makes a distinction between 2 types of events:</P>
<UL>
	<LI>standard events: no garantee of processing</LI>
	<LI>job events: garantee of processing. Someone has to do something with the event (do the job).</LI>
</UL>


<P>The event mechanism is leveraging the OSGi Event Admin Specification (OSGi Compendium 113).<BR>
The OSGi API is very simple and leightweight - sending an event is just generating the event object and calling the event admin. Receiving the event is implementing a single interface and declaring through properties which topics one is interested in. For more details please refer to the following javadocs:</P>
<UL>
	<LI>package <A href="http://www.osgi.org/javadoc/r4v42/org/osgi/service/event/package-summary.html" class="external-link" rel="nofollow">org.osgi.service.event</A> of the OSGI API.</LI>
	<LI>package <A href="http://sling.apache.org/apidocs/sling5/org/apache/sling/event/package-summary.html" class="external-link" rel="nofollow">org.apache.sling.event</A> of the Sling API.</LI>
</UL>


<P>You can learn more in the <A href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=SLINGxSITE&title=Eventing,%20Jobs%20and%20Scheduling%20section&linkCreation=true&fromPageId=23335037" class="createlink">Eventing, Jobs and Scheduling section</A> (<A href="http://sling.apache.org/site/eventing-and-jobs.html" class="external-link" rel="nofollow">http://sling.apache.org/site/eventing-and-jobs.html</A>).</P>

<P>To get started with the Sling eventing API, you will implement here a service that listens to files posted to <B>/tmp/dropbox</B> and moves them to the appropriate locations depending on the mime-type:</P>
<UL>
	<LI>images (.png) are moved to <B>/dropbox/images/</B></LI>
	<LI>music (.mp3) are moved to <B>/dropbox/music/</B></LI>
	<LI>movies (.avi) are moved to <B>/dropbox/movies/</B></LI>
	<LI>otherwise the files are moved to <B>/dropbox/other/</B></LI>
</UL>


<P>To do that, you will implement 2 services. The first one, called <B>OsgiDropBoxService</B>:</P>
<UL>
	<LI>listens to osgi event <B>resource added</B></LI>
	<LI>sends a job event<BR>
The second one, called <B>DropBoxEventHandler</B>:</LI>
	<LI>listens to job event <B>file added to /tmp/dropbox</B></LI>
	<LI>moves the file according to its extension</LI>
</UL>


<H2><A name="Managingevents-ListeningtoOSGIEvents"></A>Listening to OSGI Events</H2>

<P>To listen to the specific osgi event <B>resource added</B>:</P>
<UL>
	<LI>The service needs to implement the <B>org.osgi.service.event.EventHandler</B> interface and its <B>handleEvent(Event event)</B> method.</LI>
	<LI>The property <B>event.topics</B> needs to be set to <B>org.apache.sling.api.SlingConstants.TOPIC_RESOURCE_ADDED</B> in the class annotations.</LI>
</UL>


<P>To get a list of possible events available in Sling (resource added, removed or changed), refer to the <A href="http://sling.apache.org/apidocs/sling5/org/apache/sling/api/SlingConstants.html" class="external-link" rel="nofollow">org.apache.sling.api.SlingConstants</A> class in the Javadocs.</P>

<H2><A name="Managingevents-SendingaJobEvent"></A>Sending a Job Event</H2>

<P>To send a job event:</P>
<UL>
	<LI>The service needs to implement the <B>org.apache.sling.event.JobProcessor</B> interface and its <B>process(org.osgi.service.event.Event job)</B> method.</LI>
</UL>


<P>The first part of the code looks as follows:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
/**
 * The &lt;code&gt;OsgiDropBoxService&lt;/code&gt; is listening content added to /tmp/dropbox by using OSGI events
 * 
 * @scr.component  immediate=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN>
 * @scr.service <SPAN class="code-keyword">interface</SPAN>=<SPAN class="code-quote">&quot;org.osgi.service.event.EventHandler&quot;</SPAN>
 * @scr.property name=<SPAN class="code-quote">&quot;event.topics&quot;</SPAN> valueRef=<SPAN class="code-quote">&quot;org.apache.sling.api.SlingConstants.TOPIC_RESOURCE_ADDED&quot;</SPAN>
 */
<SPAN class="code-keyword">public</SPAN> class OsgiDropBoxService <SPAN class="code-keyword">implements</SPAN> JobProcessor, EventHandler {
</PRE>
</DIV></DIV>

<P>The Event Admin service is needed to send the job event:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
	/** 
	 * The OSGI event admin used <SPAN class="code-keyword">for</SPAN> sending events 
	 * @scr.reference
	 */
	<SPAN class="code-keyword">private</SPAN> EventAdmin eventAdmin;
</PRE>
</DIV></DIV>

<P>The job topic for dropbox job events needs to be defined:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
    /** The job topic <SPAN class="code-keyword">for</SPAN> dropbox job events. */
    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-object">String</SPAN> JOB_TOPIC = <SPAN class="code-quote">&quot;com/sling/eventing/dropbox/job&quot;</SPAN>;
</PRE>
</DIV></DIV>

<P>The org.osgi.service.event.EventHandler#handleEvent(Event event) method needs to be implemented:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
	<SPAN class="code-keyword">public</SPAN> void handleEvent(Event event) {
	    <SPAN class="code-keyword">if</SPAN> (EventUtil.isLocal(event)) {
	        EventUtil.processJob(event, <SPAN class="code-keyword">this</SPAN>);
	    }
	}
</PRE>
</DIV></DIV>

<P>The <B>org.apache.sling.event.JobProcessor#process(Event event)</B> method needs to be implemented.</P>

<P>The logic is as follows:</P>
<UL>
	<LI>the OSGI event is analyzed</LI>
	<LI>if the event is a file that has been added to &quot;/tmp/dropbox&quot;:
	<UL>
		<LI>an event is created with 2 properties:
		<UL>
			<LI>one to flag the event as a job event</LI>
			<LI>the file path</LI>
		</UL>
		</LI>
		<LI>the job event is sent to all the listeners that subscribe to the topic of the event.</LI>
	</UL>
	</LI>
</UL>


<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
	<SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">boolean</SPAN> process(Event event) {
		<SPAN class="code-object">String</SPAN> propPath = (<SPAN class="code-object">String</SPAN>) event.getProperty(SlingConstants.PROPERTY_PATH);
		<SPAN class="code-object">String</SPAN> propResType = (<SPAN class="code-object">String</SPAN>) event.getProperty(SlingConstants.PROPERTY_RESOURCE_TYPE);
		<SPAN class="code-comment">// an event is sent <SPAN class="code-keyword">if</SPAN> a file is added to /tmp/dropbox
</SPAN>		<SPAN class="code-keyword">if</SPAN> (propPath.startsWith(<SPAN class="code-quote">&quot;/tmp/dropbox&quot;</SPAN>) &amp;&amp; propResType.equals(<SPAN class="code-quote">&quot;nt:file&quot;</SPAN>)) {
    		<SPAN class="code-keyword">final</SPAN> Dictionary&lt;<SPAN class="code-object">String</SPAN>, <SPAN class="code-object">Object</SPAN>&gt; props = <SPAN class="code-keyword">new</SPAN> Hashtable&lt;<SPAN class="code-object">String</SPAN>, <SPAN class="code-object">Object</SPAN>&gt;();
            props.put(EventUtil.PROPERTY_JOB_TOPIC, JOB_TOPIC);
    		props.put(<SPAN class="code-quote">&quot;resourcePath&quot;</SPAN>, propPath);
    		Event dropboxJobEvent = <SPAN class="code-keyword">new</SPAN> Event(EventUtil.TOPIC_JOB, props);
    		eventAdmin.sendEvent(dropboxJobEvent);
    		log.info(<SPAN class="code-quote">&quot;the dropbox job has been sent: {}&quot;</SPAN>, propPath);
		}
		<SPAN class="code-keyword">return</SPAN> <SPAN class="code-keyword">true</SPAN>;
	}
</PRE>
</DIV></DIV>

<P>The whole service looks now as follows:<BR>
...</P>

<P>Now that you have a service that sends job events whenever a file is uploaded to <B>/tmp/dropbox</B>, you will create the service <B>DropBoxEventHandler</B> that listens to those job events and moves the files to a location corresponding to their mime-types.</P>

<H2><A name="Managingevents-ListeningtoJobEvents"></A>Listening to Job Events</H2>

<P>To listen to the job events that have been defined before:</P>
<UL>
	<LI>The service also needs to implement the <B>org.osgi.service.event.EventHandler</B> interface and its <B>handleEvent(Event event)</B> method.</LI>
	<LI>The property <B>event.topics</B> needs to be set to <B>com.jck.sling.eventing.osgi.OsgiDropBoxService.JOB_TOPIC</B> in the class annotations.</LI>
</UL>


<P>To move the files:</P>
<UL>
	<LI>The service needs to implement the <B>org.apache.sling.event.JobProcessor</B> interface and its <B>process(org.osgi.service.event.Event job)</B> method.</LI>
</UL>


<P>The first part of the code looks as follows:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
/**
 * @scr.component  immediate=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN>
 * @scr.service <SPAN class="code-keyword">interface</SPAN>=<SPAN class="code-quote">&quot;org.osgi.service.event.EventHandler&quot;</SPAN>
 * @scr.property name=<SPAN class="code-quote">&quot;event.topics&quot;</SPAN> valueRef=<SPAN class="code-quote">&quot;com.jck.sling.eventing.osgi.OsgiDropBoxService.JOB_TOPIC&quot;</SPAN>
 */

<SPAN class="code-keyword">public</SPAN> class DropBoxEventHandler <SPAN class="code-keyword">implements</SPAN> JobProcessor, EventHandler {
</PRE>
</DIV></DIV>


<P>Several class fields are defined:</P>
<UL>
	<LI>for logging</LI>
	<LI>to reference the SlingRepository and the JcrResourceResolverFactory services, which are used in the implementation</LI>
	<LI>to define the destination path of the files</LI>
</UL>


 <DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
   /** Default log. */
    <SPAN class="code-keyword">protected</SPAN> <SPAN class="code-keyword">final</SPAN> Logger log = LoggerFactory.getLogger(<SPAN class="code-keyword">this</SPAN>.getClass());

    <SPAN class="code-keyword">private</SPAN> Session adminSession;
    
    /** @scr.reference */
    <SPAN class="code-keyword">private</SPAN> SlingRepository repository;
    
    /**
     * @scr.reference
     */
    <SPAN class="code-keyword">private</SPAN> JcrResourceResolverFactory resolverFactory;
    
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-object">String</SPAN> IMAGES_PATH = <SPAN class="code-quote">&quot;/dropbox/images/&quot;</SPAN>;
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-object">String</SPAN> MUSIC_PATH = <SPAN class="code-quote">&quot;/dropbox/music/&quot;</SPAN>;
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-object">String</SPAN> MOVIES_PATH = <SPAN class="code-quote">&quot;/dropbox/movies/&quot;</SPAN>;
    <SPAN class="code-keyword">private</SPAN> <SPAN class="code-keyword">final</SPAN> <SPAN class="code-keyword">static</SPAN> <SPAN class="code-object">String</SPAN> OTHER_PATH = <SPAN class="code-quote">&quot;/dropbox/other/&quot;</SPAN>;
</PRE>
</DIV></DIV>

<H2><A name="Managingevents-HandlingJobEvents"></A>Handling Job Events</H2>

<P>The <B>org.osgi.service.event.EventHandler#handleEvent(Event event)</B> method needs to be implemented:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
	<SPAN class="code-keyword">public</SPAN> void handleEvent(Event event) {
	    <SPAN class="code-keyword">if</SPAN> (EventUtil.isLocal(event)) {
	        EventUtil.processJob(event, <SPAN class="code-keyword">this</SPAN>);
	    }
	}
</PRE>
</DIV></DIV>

<P>The <B>org.apache.sling.event.JobProcessor#process(Event event)</B> method needs to be implemented.<BR>
The logic is as follows:</P>
<UL>
	<LI>the resource path is extracted from the job event property</LI>
	<LI>the resource is obtained from the file path</LI>
	<LI>if the resource is a file, the destination path is defined based on the file mime-type</LI>
	<LI>the file is moved to the new location</LI>
</UL>


<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
	<SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">boolean</SPAN> process(Event event) {
		<SPAN class="code-keyword">try</SPAN> {
			<SPAN class="code-object">String</SPAN> resourcePath = (<SPAN class="code-object">String</SPAN>) event.getProperty(<SPAN class="code-quote">&quot;resourcePath&quot;</SPAN>);
			<SPAN class="code-object">String</SPAN> resourceName = resourcePath.substring(resourcePath.lastIndexOf(<SPAN class="code-quote">&quot;/&quot;</SPAN>) + 1);
        	adminSession = repository.loginAdministrative(<SPAN class="code-keyword">null</SPAN>);
	        ResourceResolver resourceResolver = resolverFactory.getResourceResolver(adminSession);
	        Resource res = resourceResolver.getResource(resourcePath);
	        <SPAN class="code-keyword">if</SPAN> (ResourceUtil.isA(res, <SPAN class="code-quote">&quot;nt:file&quot;</SPAN>)) {
	        	<SPAN class="code-object">String</SPAN> mimeType = res.getResourceMetadata().getContentType();
	        	<SPAN class="code-object">String</SPAN> destDir;
	        	<SPAN class="code-keyword">if</SPAN> (mimeType.equals(<SPAN class="code-quote">&quot;image/png&quot;</SPAN>)) {
	        		destDir = IMAGES_PATH;
	        	}
	        	<SPAN class="code-keyword">else</SPAN> <SPAN class="code-keyword">if</SPAN> (mimeType.equals(<SPAN class="code-quote">&quot;audio/mpeg&quot;</SPAN>)) {
	        		destDir = MUSIC_PATH;
	        	}
	        	<SPAN class="code-keyword">else</SPAN> <SPAN class="code-keyword">if</SPAN> (mimeType.equals(<SPAN class="code-quote">&quot;video/x-msvideo&quot;</SPAN>)) {
	        		destDir = MOVIES_PATH;
	        	}
	        	<SPAN class="code-keyword">else</SPAN> {
	        		destDir = OTHER_PATH;
	        	}
        		adminSession.move(resourcePath, destDir + resourceName);
	        	adminSession.save();
	        	log.info(<SPAN class="code-quote">&quot;The file {} has been moved to {}&quot;</SPAN>, resourceName, destDir);
	        }
	        <SPAN class="code-keyword">return</SPAN> <SPAN class="code-keyword">true</SPAN>;
		} <SPAN class="code-keyword">catch</SPAN> (RepositoryException e) {
			log.error(<SPAN class="code-quote">&quot;RepositoryException: &quot;</SPAN> + e);
			<SPAN class="code-keyword">return</SPAN> <SPAN class="code-keyword">false</SPAN>;
        } <SPAN class="code-keyword">finally</SPAN> {
            <SPAN class="code-keyword">if</SPAN> (adminSession != <SPAN class="code-keyword">null</SPAN> &amp;&amp; adminSession.isLive()) {
            	adminSession.logout();
            	adminSession = <SPAN class="code-keyword">null</SPAN>;
            }
        }
	}
</PRE>
</DIV></DIV>

<P>The complete code for the service looks as follows:<BR>
...</P>

        <DIV class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
Last modified by jck on Mon Aug 16 08:58:35 EDT 2010
        </DIV>
    </DIV>
  </BODY>
</HTML>

