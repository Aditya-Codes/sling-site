
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML>
  <HEAD>
    <TITLE>Apache Sling - Rewriting the Output Through Pipelines</TITLE>
    <LINK rel="stylesheet" href="http://sling.apache.org/site/media.data/site.css" type="text/css" media="all">
    <LINK rel="icon" href="http://sling.apache.org/site/media.data/favicon.ico">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY><div class="siteconversion">This is an old version of the Sling website, see the <a href="http://sling.apache.org/site-conversion.html">site conversion page</a> for more info.</div>
    <DIV class="title">
      <DIV class="logo">
        <A href="http://sling.apache.org/site/index.html">
          <IMG border="0" alt="Apache Sling" src="http://sling.apache.org/site/media.data/logo.png">
        </A>
      </DIV>
    </DIV>
    <DIV class="menu">
<P><B>Documentation</B><BR clear="all">
<A href="getting-started.html" title="Getting Started">Getting Started</A><BR clear="all">
<A href="the-sling-engine.html" title="The Sling Engine">The Sling Engine</A><BR clear="all">
<A href="development.html" title="Development">Development</A><BR clear="all">
<A href="bundles.html" title="Bundles">Bundles</A><BR clear="all">
<A href="tutorials-how-tos.html" title="Tutorials & How-Tos">Tutorials &amp; How&#45;Tos</A><BR clear="all">
<A href="configuration.html" title="Configuration">Configuration</A><BR clear="all">
<A href="http://sling.apache.org/apidocs/sling5/index.html" rel="nofollow">API docs</A><BR clear="all">
<A href="http://cwiki.apache.org/SLING/" rel="nofollow">Wiki</A><BR clear="all">
<A href="http://cwiki.apache.org/SLING/faq.html" rel="nofollow">FAQ</A><BR clear="all"></P>

<P><B>Project info</B><BR clear="all">
<A href="http://sling.apache.org/site/downloads.cgi" rel="nofollow">Downloads</A><BR clear="all">
<A href="contributing.html" title="Contributing">Contributing</A><BR clear="all">
<A href="news.html" title="News">News</A><BR clear="all">
<A href="links.html" title="Links">Links</A><BR clear="all">
<A href="project-information.html" title="Project Information">Project Information</A><BR clear="all"></P>

<P><B>Sponsorship</B><BR clear="all">
<A href="http://www.apache.org/foundation/thanks.html" rel="nofollow">Thanks</A><BR clear="all">
<A href="http://www.apache.org/foundation/sponsorship.html" rel="nofollow">Become a Sponsor</A><BR>
<A href="http://www.apache.org/foundation/buy_stuff.html" rel="nofollow">Buy Stuff</A></P>


<IFRAME src="http://www.apache.org/ads/button.html" style="border-width:0; float: left" frameborder="0" scrolling="no" width="135" height="135"></IFRAME>
<P style="height: 100px"></P>

    </DIV>
    <DIV class="main">
        <DIV class="breadcrump" style="font-size: 80%;">
<A href="apache-sling.html" title="Apache Sling Website">Apache Sling Website</A>&nbsp;&gt;&nbsp;<A href="apache-sling.html" title="Apache Sling">Apache Sling</A>&nbsp;&gt;&nbsp;<A href="documentation.html" title="Documentation">Documentation</A>&nbsp;&gt;&nbsp;<A href="tutorials-how-tos.html" title="Tutorials & How-Tos">Tutorials &amp; How-Tos</A>&nbsp;&gt;&nbsp;<A href="" title="Rewriting the Output Through Pipelines">Rewriting the Output Through Pipelines</A>
        </DIV>
<H1><A name="RewritingtheOutputThroughPipelines-ApacheSlingRewriter"></A>Apache Sling Rewriter</H1>

<P>The Apache Sling rewriter is a module for rewriting the output. The output from Sling can be rewritten by a SAX based pipeline or a single component (called a Processor).</P>

<H2><A name="RewritingtheOutputThroughPipelines-SAXPipelines"></A>SAX Pipelines</H2>
<P>The rewriter allows to configure a pipeline for post processing of the generated response.</P>

<P>The pipeline starts with a generator. The generator gets the output from Sling. It's the task of the generator to generate SAX events (XML) and stream these into the pipeline. A transformer is a component in the middle of the pipeline, a pipeline can have zero to n transformers. The transformer receives SAX events from the previous component in the pipeline and sends SAX events to the next component in the pipeline. A transformer can remove events, change events, add events or just pass on the events. The pipeline ends with a serializer collecting all SAX events and writing the output to a provided output stream.</P>

<P>Sling contains a default pipeline which is executed for all html responses: it starts with an html generator, parsing the html output and sending events into the pipeline. A html serializer collects all events and serializes the output. </P>

<P>The pipelines can be configured in the repository as a child node of <EM>/apps/APPNAME/config/rewriter</EM> (or <EM>/libs/APPNAME/config/rewriterg</EM>). (In fact the configured search paths of the resource resolver are observed.) Each node can have the following properties:</P>
<UL>
	<LI>generatorType - the type of the generator (required)</LI>
	<LI>serializerType - the type of the serializer (required)</LI>
	<LI>transformerTypes (multivalue string) - the types of the transformers (optional)</LI>
	<LI>paths (multivalue string) - the paths this pipeline should run on (content paths)</LI>
	<LI>contentTypes (multivalue string) - the content types this pipeline should be used for (optional)</LI>
	<LI>order (long) - the configurations are sorted by this order, order must be higher or equal to 0. The configuration with the highest order is tried first.</LI>
	<LI>enabled (boolean) - Is this configuration active? (default yes)</LI>
</UL>


<P>If a component needs a configuration, the configuration is stored in a child node which name is <EM>COMPONENTTYPE-NAME</EM>, e.g. to configure the html generator (named <EM>html-generator</EM>), the node should have the name <EM>generator-html-generator</EM>.</P>

<H3><A name="RewritingtheOutputThroughPipelines-ConfiguringtheHTMLGenerator"></A>Configuring the HTML Generator</H3>

<P>By default the used html generator only generates events for some of the html tags. If you want to change this, create a pipeline config like outlined above for the pipeline and configure the html generator by adding the <EM>generator-html-generator</EM> node with a multi value string property named <EM>includeTags</EM>. The values define the tags, the parser uses.</P>

<H3><A name="RewritingtheOutputThroughPipelines-DefaultPipeline"></A>Default Pipeline</H3>

<P>The default pipeline is configured for the <EM>text/html</EM> mime type and consists of the <EM>html-generator</EM> as generator, and the <EM>html-serializer</EM> for generating the final response.<BR>
As the html generated by Sling is not required to be valid XHTML, the html parser is only sending partial SAX events into the pipeline, therefore modifications of the complete page are not possible with this approach. For complete page modifications, the Sling scripts need to generate XHTML and an according parser needs to be used. It is also possible to integrate an HTML parser which converts the HTML to XHTML.</P>

<H2><A name="RewritingtheOutputThroughPipelines-ImplementingPipelineComponents"></A>Implementing Pipeline Components</H2>
<P>Each pipeline component type has a corresponding Java interface (Generator, Transformer, and Serializer) together with a factory interface (GeneratorFactory, TransformerFactory, and SerializerFactory). When implementing such a component, both interfaces need to be implemented. The factory has only one method which creates a new instance of that type for the current request. The factory has to be registered as a service. For example if you're using the Maven SCR plugin, it looks like this:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@scr.component metatype=<SPAN class="code-quote">&quot;no&quot;</SPAN> 
@scr.service <SPAN class="code-keyword">interface</SPAN>=<SPAN class="code-quote">&quot;TransformerFactory&quot;</SPAN>
@scr.property value=<SPAN class="code-quote">&quot;pipeline.type&quot;</SPAN> value=<SPAN class="code-quote">&quot;validator&quot;</SPAN>
</PRE>
</DIV></DIV>

<P>The factory needs to implement the according interface and should be registered as a service for this factory. Each factory gets a unique name through the <EM>pipeline.type</EM> property. The pipeline configuration in the repository just references this unique name (like validator).</P>

<H2><A name="RewritingtheOutputThroughPipelines-ExtendingthePipeline"></A>Extending the Pipeline</H2>
<P>With the possibilities from above, it is possible to define new pipelines and add custom components to the pipeline. However, in some cases it is required to just add a custom transformer to the existing pipeline. Therefore the rewriting can be configured with pre and post transformers that are simply added to each configured pipeline. This allows a more flexible way of customizing the pipeline without changing/adding a configuration in the repository.</P>

<P>The approach here is nearly the same. A transformer factory needs to be implemented, but instead of giving this factory a unique name, this factory is marked as a global factory:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@scr.component metatype=<SPAN class="code-quote">&quot;no&quot;</SPAN>
@scr.service <SPAN class="code-keyword">interface</SPAN>=<SPAN class="code-quote">&quot;TransformerFactory&quot;</SPAN>
@scr.property name=<SPAN class="code-quote">&quot;pipeline.mode&quot;</SPAN> value=<SPAN class="code-quote">&quot;global&quot;</SPAN>
@scr.property name=<SPAN class="code-quote">&quot;service.ranking&quot;</SPAN> value=<SPAN class="code-quote">&quot;RANKING&quot;</SPAN> type=<SPAN class="code-quote">&quot;<SPAN class="code-object">Integer</SPAN>&quot;</SPAN>
</PRE>
</DIV></DIV>
<P><EM>RANKING</EM> is an integer value (don't forget the type attribute otherwise the ranking is interpreted as zero!) specifying where to add the transformer in the pipeline. If the value is less than zero the transformer is added at the beginning of the pipeline right after the generator. If the ranking is equal or higher as zero, the transformer is added at the end of the pipeline before the serializer.</P>

<P>The <EM>TransformerFactory</EM> interface has just one method which returns a new transformer instance. If you plan to use other services in your transformer you might declare the references on the factory and pass in the instances into the newly created transformer.</P>


<H2><A name="RewritingtheOutputThroughPipelines-ImplementingaProcessor"></A>Implementing a Processor</H2>
<P>A processor must conform to the Java interface <EM>org.apache.sling.rewriter.Processor</EM>. It gets initializd (method <EM>init</EM>) with the <EM>ProcessingContext</EM>. This context contains all necessary information for the current request (especially the output writer to write the rewritten content to).<BR>
The <EM>getWriter</EM> method should return a writer where the output is written to. When the output is written or an error occured <EM>finished</EM> is called.</P>

<P>Like the pipeline components a processor is generated by a factory which has to be registered as a service factory, like this:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@scr.component metatype=<SPAN class="code-quote">&quot;no&quot;</SPAN> 
@scr.service <SPAN class="code-keyword">interface</SPAN>=<SPAN class="code-quote">&quot;ProcessorFactory&quot;</SPAN>
@scr.property value=<SPAN class="code-quote">&quot;pipeline.type&quot;</SPAN> value=<SPAN class="code-quote">&quot;uniqueName&quot;</SPAN>
</PRE>
</DIV></DIV>

<H2><A name="RewritingtheOutputThroughPipelines-ConfiguringaProcessor"></A>Configuring a Processor</H2>
<P>The processors can be configured in the repository as a child node of <EM>/apps/APPNAME/config/rewriter</EM> (or libs or any configured search path). Each node can have the following properties:</P>
<UL>
	<LI>processorType - the type of the processor (required) - this is the part from the scr factory information after the slash (in the example above this is <EM>uniqueName</EM>)</LI>
	<LI>paths (multivalue string) - the paths this processor should run on (content paths)</LI>
	<LI>contentTypes (multivalue string) - the content types this processor should be used for (optional)</LI>
	<LI>order (long) - the configurations are sorted by this order, order must be higher or equal to 0. The configuration with the highest order is tried first.</LI>
	<LI>enabled (boolean) - Is this configuration active? (default yes)</LI>
</UL>


        <DIV class="timestamp" style="margin-top: 30px; font-size: 80%; text-align: right;">
Last modified by cziegeler@apache.org on 2009-06-09 03:15:45.0
        </DIV>
    </DIV>
  </BODY>
</HTML>

